(function(e,t,n){var r=function(t){var n=t.split("."),r=e;for(var i=0;i<n.length;i++)r[n[i]]||(r[n[i]]={}),r=r[n[i]]};r("com.qici.extraUI");var i=qc.ScrollView,s=com.qici.extraUI.ScrollSupport=function(e,t,n,r,s){this.game=e,this.node=t,this._getViewRect=n,this._getContentRect=r,this._setContentPosition=s,this.canHorizontal=!0,this.canVertical=!0,this.movementType=i.MOVEMENT_ELASTIC,this.elasticity=1,this.inertia=!0,this.decelerationRate=.03,this.scrollSensitivity=1,this.propagationScroll=!1,this.onValueChange=new Phaser.Signal,this._preContentPosition=null,this._preContentRect=null,this._preViewRect=null,this._velocity=new qc.Point(0,0),this._isDragging=!1,this.pivotX=0,this.pivotY=0,this.node&&(this.node.onWheel.add(this._doWheel,this),this.node.onDragStart.add(this._doDragStart,this),this.node.onDrag.add(this._doDrag,this),this.node.onDragEnd.add(this._doDragEnd,this))};s.prototype={},s.prototype.constructor=s,t.defineProperties(s.prototype,{horizontalScrollBar:{get:function(){return this._horizontalScrollBar&&this._horizontalScrollBar._destroy&&(this._horizontalScrollBar=null),this._horizontalScrollBar},set:function(e){this._horizontalScrollBar&&this._horizontalScrollBar.onValueChange.remove(this._setHorizontalNormalizedPosition,this),this._horizontalScrollBar=e,this._horizontalScrollBar&&this._horizontalScrollBar.onValueChange.add(this._setHorizontalNormalizedPosition,this)}},verticalScrollBar:{get:function(){return this._verticalScrollBar&&this._verticalScrollBar._destroy&&(this._verticalScrollBar=null),this._verticalScrollBar},set:function(e){this._verticalScrollBar&&this._verticalScrollBar.onValueChange.remove(this._setVerticalNormalizedPosition,this),this._verticalScrollBar=e,this._verticalScrollBar&&this._verticalScrollBar.onValueChange.add(this._setVerticalNormalizedPosition,this)}},horizontalNormalizedPosition:{get:function(){return this._updateBounds(),this._contentRect.width<=this._viewRect.width?this._viewRect.x>this._contentRect.x?1:0:(this._viewRect.x-this._contentRect.x)/(this._contentRect.width-this._viewRect.width)},set:function(e){this.setNormalizedPosition(e,0)}},verticalNormalizedPosition:{get:function(){return this._updateBounds(),this._contentRect.height<=this._viewRect.height?this._viewRect.y>this._contentRect.y?1:0:(this._viewRect.y-this._contentRect.y)/(this._contentRect.height-this._viewRect.height)},set:function(e){this.setNormalizedPosition(e,1)}}}),s.prototype.destroy=function(){this.node&&(this.node.onWheel.remove(this._doWheel,this),this.node.onDragStart.remove(this._doDragStart,this),this.node.onDrag.remove(this._doDrag,this),this.node.onDragEnd.remove(this._doDragEnd,this)),this.node=null,this._setContentPosition=null,this._getContentRect=null,this._getViewRect=null,this.horizontalScrollBar=null,this.verticalScrollBar=null},s.prototype.update=function(e){this._updateVelocity(e)},s.prototype.getViewRect=function(){return this._getViewRect?this._getViewRect():new qc.Rectangle(0,0,0,0)},s.prototype.getContentRect=function(){return this._getContentRect?this._getContentRect():new qc.Rectangle(0,0,0,0)},s.prototype.setContentPosition=function(e,t){this._setContentPosition&&this._setContentPosition(e,t)},s.prototype._setHorizontalNormalizedPosition=function(e){this.setNormalizedPosition(e,0)},s.prototype._setVerticalNormalizedPosition=function(e){this.setNormalizedPosition(e,1)},s.prototype._calculateOffset=function(e,t){var n=new qc.Point(0,0);if(this.movementType===i.MOVEMENT_UNRESTRICTED)return n;var r=this.getViewRect(),s=this._contentRect,o=new qc.Point(s.x,s.y),u=new qc.Point(s.x+s.width,s.y+s.height);return this.canHorizontal&&(o.x+=e,u.x+=e,o.x>r.x?n.x=r.x-o.x:u.x<r.x+r.width&&(n.x=r.x+r.width-u.x)),this.canVertical&&(o.y+=t,u.y+=t,o.y>r.y?n.y=r.y-o.y:u.y<r.y+r.height&&(n.y=r.y+r.height-u.y)),n},s.prototype._calcVelocityEffect=function(e,t,n,r){if(this.movementType===i.MOVEMENT_ELASTIC&&t[r]!==0){var s=this["_lastOffset_"+r]||0;Math.abs(s)<Math.abs(t[r])?(this["_lastOffset_"+r]=t[r],this._currSmoothetTime=n):(this["_lastOffset_"+r]=t[r],this._currSmoothetTime+=n);var o=this.elasticity<=0?n:this.elasticity,u=this.game.math.smoothDamp(e[r],e[r]+t[r],this._velocity[r],this.elasticity,Number.MAX_VALUE,n/100);Math.abs(e[r]+t[r]-u[0])<1e-4?(e[r]=e[r]+t[r],this._velocity[r]=0):(e[r]=u[0],this._velocity[r]=u[1])}else if(this.movementType===i.MOVEMENT_CLAMPED&&t[r]!==0)e[r]=e[r]+t[r];else if(this.inertia){var a=this._velocity[r]*Math.pow(Math.abs(this.decelerationRate),n/1e3);Math.abs(a)<1&&(a=0),this._velocity[r]=a,e[r]=e[r]+a*n/1e3}else this._velocity[r]=0},s.prototype._rubberDelta=function(e,t){return(1-1/(Math.abs(e)*.55/t+1))*t*this.game.math.sign(e)},s.prototype._updateVelocity=function(e){var t,n;this._updateBounds();var r=this._calculateOffset(0,0);!this._isDragging&&(r.x!==0||r.y!==0||this._velocity.x!==0||this._velocity.y!==0)&&(t=this.getContentRect(),n=new qc.Point(t.x,t.y),this._calcVelocityEffect(n,r,e,"x"),this._calcVelocityEffect(n,r,e,"y"),(this._velocity.x!==0||this._velocity.y!==0)&&this.movementType===i.MOVEMENT_CLAMPED&&(r=this._calculateOffset(n.x-t.x,n.y-t.y),n.x+=r.x,n.y+=r.y),this.setContentPosition(n.x,n.y));if(this._isDragging&&this.inertia){t=this.getContentRect();var s=t.x-this._preContentPosition.x,o=t.y-this._preContentPosition.y,u=this.game.math.clamp(e/1e3,0,1);this._velocity.x=s/u,this._velocity.y=o/u}if(!this._preViewRect||!qc.Rectangle.equals(this._viewRect,this._preViewRect)||!this._preContentRect||!qc.Rectangle.equals(this._contentRect,this._preContentRect))this._updateScrollBars(r.x,r.y),this.onValueChange.dispatch(new qc.Point(this.horizontalNormalizedPosition,this.verticalNormalizedPosition)),this._updatePrevData()},s.prototype.setNormalizedPosition=function(e,t){this._updateBounds();if(!this._contentRect)return;var n=this.getContentRect(),r=t?"height":"width",i=t?"y":"x",s=this._contentRect[r]-this._viewRect[r],o=this._viewRect[i]-e*s,u=n[i]+o-this._contentRect[i],a=n[i];Math.abs(a-u)>1&&(n[i]=u,this.setContentPosition(n.x,n.y),this._velocity[i]=0,this._updateBounds())},s.prototype._updatePrevData=function(){var e=this.getContentRect();this._preContentPosition=new qc.Point(e.x,e.y),this._preContentRect=this._contentRect,this._preViewRect=this._viewRect},s.prototype._updateScrollBars=function(e,t){var n;this.horizontalScrollBar&&(this._contentRect.width>0?(n=(this._viewRect.width-Math.abs(e))/this._contentRect.width,this.horizontalScrollBar.size=Phaser.Math.clamp(n,0,1)):this.horizontalScrollBar.size=1,this.horizontalScrollBar.value=this.horizontalNormalizedPosition),this.verticalScrollBar&&(this._contentRect.height>0?(n=(this._viewRect.height-Math.abs(t))/this._contentRect.height,this.verticalScrollBar.size=Phaser.Math.clamp(n,0,1)):this.verticalScrollBar.size=1,this.verticalScrollBar.value=this.verticalNormalizedPosition)},s.prototype._updateBounds=function(){var e=this._viewRect=this.getViewRect();this._updateContentBounds();if(!this._getContentRect)return;var t=e.width-this._contentRect.width,n=e.height-this._contentRect.height;t>0&&(this._contentRect.width=e.width,this._contentRect.x-=t*this.pivotX),n>0&&(this._contentRect.height=e.height,this._contentRect.y-=n*this.pivotY)},s.prototype._updateContentBounds=function(){this._contentRect=this.getContentRect()},s.prototype._doWheel=function(e,t){this._updateBounds();var n=new qc.Point(t.source.deltaX,t.source.deltaY);this.canVertical||(n.y=0),this.canHorizontal||(n.x=0);var r=n.x*this.scrollSensitivity,i=n.y*this.scrollSensitivity;this.doScroll(r,i,!1)},s.prototype._doDragStart=function(e,t){if(t.source.eventId!==qc.Mouse.BUTTON_LEFT)return;this._updateBounds();var n=this.getContentRect();this._contentStartPosition=new qc.Point(n.x,n.y),this._pointerStartCursor=this.node.toLocal(new qc.Point(t.source.startX,t.source.startY)),this._isDragging=!0},s.prototype._doDragEnd=function(e,t){if(t.source.eventId!==qc.Mouse.BUTTON_LEFT)return;this._isDragging=!1},s.prototype._doDrag=function(e,t){if(t.source.eventId!==qc.Mouse.BUTTON_LEFT)return;this._updateBounds();var n=this.getContentRect(),r=this.node.toLocal(new qc.Point(t.source.x,t.source.y));if(!this._pointerStartCursor)return;var i=this.canHorizontal?r.x-this._pointerStartCursor.x:0,s=this.canVertical?r.y-this._pointerStartCursor.y:0;this.doScroll(this._contentStartPosition.x+i-n.x,this._contentStartPosition.y+s-n.y,!0)},s.prototype.doScroll=function(e,t,n){var r=this.getContentRect(),s=new qc.Point(r.x,r.y);s.x+=e,s.y+=t;var o=this._calculateOffset(e,t);s.x+=o.x,s.y+=o.y;if(this.movementType===i.MOVEMENT_CLAMPED&&this.propagationScroll){var u=this.parent;while(!(u instanceof i)&&u!==this.game.world)u=u.parent;u instanceof i&&u.doScroll(-o.x,-o.y,n)}else this.movementType===i.MOVEMENT_ELASTIC&&(n?(o.x!==0&&(s.x=s.x-this._rubberDelta(o.x,this._viewRect.width)),o.y!==0&&(s.y=s.y-this._rubberDelta(o.y,this._viewRect.height))):(s.x-=o.x,s.y-=o.y,Math.abs(o.x)>this._viewRect.width&&(s.x+=o.x-this.game.math.sign(o.x)*this._viewRect.width),Math.abs(o.y)>this._viewRect.height&&(s.y+=o.y-this.game.math.sign(o.y)*this._viewRect.height)));this.setContentPosition(s.x,s.y),n||this._updateBounds()};var o=qc.defineBehaviour("com.qici.extraUI.TableViewAdapter",qc.Behaviour,function(){var e=this;e.onDataChange=new qc.Signal},{});t.defineProperties(o.prototype,{}),o.prototype.dispatchDataChange=function(){this.onDataChange.dispatch()},o.prototype.getTableSize=function(){return{x:1,y:Infinity}},o.prototype.findCellWithPos=function(e,t){return{x:Math.floor(e/100),y:Math.floor(t/100)}},o.prototype.getCellRect=function(e,t){return new qc.Rectangle(e*100,t*100,100,100)},o.prototype.revokeCell=function(e,t,n){},o.prototype.createCell=function(e,t,n){};var u=qc.defineBehaviour("com.qici.extraUI.TableView",qc.Behaviour,function(){var e=this;e._cellPool=[],e._usingCell=[],e._showRect=new qc.Rectangle(0,0,0,0),e.scrollSupport=new com.qici.extraUI.ScrollSupport(e.game,e.gameObject,e._getViewRect.bind(e),e._getContentRect.bind(e),e._setContentPosition.bind(e)),e.runInEditor=!0},{content:qc.Serializer.NODE,adapterNode:qc.Serializer.NODE,horizontalScrollBar:qc.Serializer.NODE,verticalScrollBar:qc.Serializer.NODE,cellPrefab:qc.Serializer.PREFAB,overflow:qc.Serializer.BOOLEAN,canHorizontal:qc.Serializer.BOOLEAN,canVertical:qc.Serializer.BOOLEAN,movementType:qc.Serializer.NUMBER,elasticity:qc.Serializer.NUMBER,inertia:qc.Serializer.BOOLEAN,decelerationRate:qc.Serializer.NUMBER,scrollSensitivity:qc.Serializer.NUMBER,propagationScroll:qc.Serializer.BOOLEAN,extraLeft:qc.Serializer.NUMBER,extraRight:qc.Serializer.NUMBER,extraTop:qc.Serializer.NUMBER,extraBottom:qc.Serializer.NUMBER});t.defineProperties(u.prototype,{adapterNode:{get:function(){return this._adapterNode||this.gameObject},set:function(e){if(e===this._adapterNode)return;this._adapterNode=e,this._adapter&&(this._adapter.onDataChange.remove(this._clearTable,this),this._adapter=null),this._needRebuild=!0}},adapter:{get:function(){return this._adapter||(this._adapter=this.adapterNode&&this.adapterNode.getScript("com.qici.extraUI.TableViewAdapter"),this._adapter&&this._adapter.onDataChange.add(this._clearTable,this)),this._adapter}},content:{get:function(){return this._content&&this._content._destroy&&(this.content=null),this._content},set:function(e){var t=this;t._content&&(t._content.onChildrenChanged.remove(t._doChildrenChanged,t),t._content.onLayoutArgumentChanged.remove(t._doLayoutArgumentChanged,t)),t._content=e,t._needRebuild=!0,t._content&&(t._content.onChildrenChanged.add(t._doChildrenChanged,t),t._content.onLayoutArgumentChanged.add(t._doLayoutArgumentChanged,t))}},cellPrefab:{get:function(){return this._cellPrefab},set:function(e){if(e===this._cellPrefab)return;this._cellPrefab=e,this.content&&this.content.removeChildren(),this._cellPool=[],this._needRebuild=!0}},overflow:{get:function(){return this._overflow},set:function(e){if(e===this._overflow)return;this._overflow=e,this._needRebuild=!0}},extraLeft:{get:function(){return this._extraLeft||0},set:function(e){if(e===this._extraLeft)return;this._extraLeft=e,this._needRebuild=!0}},extraRight:{get:function(){return this._extraRight||0},set:function(e){if(e===this._extraRight)return;this._extraRight=e,this._needRebuild=!0}},extraTop:{get:function(){return this._extraTop||0},set:function(e){if(e===this._extraTop)return;this._extraTop=e,this._needRebuild=!0}},extraBottom:{get:function(){return this._extraBottom||0},set:function(e){if(e===this._extraBottom)return;this._extraBottom=e,this._needRebuild=!0}},canHorizontal:{get:function(){return this.scrollSupport?this.scrollSupport.canHorizontal:null},set:function(e){this.scrollSupport&&(this.scrollSupport.canHorizontal=e)}},canVertical:{get:function(){return this.scrollSupport?this.scrollSupport.canVertical:null},set:function(e){this.scrollSupport&&(this.scrollSupport.canVertical=e)}},movementType:{get:function(){return this.scrollSupport?this.scrollSupport.movementType:null},set:function(e){this.scrollSupport&&(this.scrollSupport.movementType=e)}},elasticity:{get:function(){return this.scrollSupport?this.scrollSupport.elasticity:null},set:function(e){this.scrollSupport&&(this.scrollSupport.elasticity=e)}},inertia:{get:function(){return this.scrollSupport?this.scrollSupport.inertia:null},set:function(e){this.scrollSupport&&(this.scrollSupport.inertia=e)}},decelerationRate:{get:function(){return this.scrollSupport?this.scrollSupport.decelerationRate:null},set:function(e){this.scrollSupport&&(this.scrollSupport.decelerationRate=e)}},scrollSensitivity:{get:function(){return this.scrollSupport?this.scrollSupport.scrollSensitivity:null},set:function(e){this.scrollSupport&&(this.scrollSupport.scrollSensitivity=e)}},propagationScroll:{get:function(){return this.scrollSupport?this.scrollSupport.propagationScroll:null},set:function(e){this.scrollSupport&&(this.scrollSupport.propagationScroll=e)}},horizontalScrollBar:{get:function(){return this.scrollSupport?this.scrollSupport.horizontalScrollBar:null},set:function(e){this.scrollSupport&&(this.scrollSupport.horizontalScrollBar=e)}},verticalScrollBar:{get:function(){return this.scrollSupport?this.scrollSupport.verticalScrollBar:null},set:function(e){this.scrollSupport&&(this.scrollSupport.verticalScrollBar=e)}},horizontalNormalizedPosition:{get:function(){return this.scrollSupport?this.scrollSupport.horizontalNormalizedPosition:null},set:function(e){this.scrollSupport&&this.scrollSupport.setNormalizedPosition(e,0)}},verticalNormalizedPosition:{get:function(){return this.scrollSupport?this.scrollSupport.verticalNormalizedPosition:null},set:function(e){this.scrollSupport&&this.scrollSupport.setNormalizedPosition(e,1)}}}),u.prototype.awake=function(){},u.prototype.onDestroy=function(){var e=this;e.content=null,e.cellPrefab=null,e._adapter=null,e.adapterNode=null,e._cellPool=[],e._showCell=[],e._usingCell=[]},u.prototype.update=function(){this.content&&(this.scrollSupport.pivotX=this.content.pivotX,this.scrollSupport.pivotY=this.content.pivotY),this.scrollSupport.update(this.game.time.deltaTime),this._needRebuild&&this._rebuildTable()},u.prototype.relayout=function(){this._rebuildTable()},u.prototype._clearTable=function(){var e=this,t=e.gameObject,n=e.content;n.x=0,n.y=0,e.revokeAllCell()},u.prototype.revokeAllCell=function(){var e=this,t=e.content;t.removeChildren(),Array.prototype.push.apply(e._cellPool,e._usingCell),e._usingCell=[]},u.prototype._revokeCell=function(e){var t=this;t._cellPool.push(e);var n=t._usingCell.indexOf(e);n>=0&&t._usingCell.splice(n,1)},u.prototype._createCell=function(){var e=this;if(!e._cellPrefab)return null;var t=e._cellPool.pop()||e.game.add.clone(e._cellPrefab,e.gameObject);return t&&e._usingCell.push(t),t},u.prototype._getViewRect=function(){return this.gameObject.rect},u.prototype._getContentRect=function(){var e=this,t=e.adapter,n=e.content;if(!n||!t)return new qc.Rectangle(0,0,0,0);var r=t.getTableSize(),i=r.x<Infinity?r.x-1:0,s=r.y<Infinity?r.y-1:0,o=t.getCellRect(i,s);return new qc.Rectangle(n.x,n.y,r.x<Infinity?o.x+o.width:Infinity,r.y<Infinity?o.y+o.height:Infinity)},u.prototype._setContentPosition=function(e,t){var n=this,r=n.content;if(!r)return;r.x=e,r.y=t,n._rebuildTable()},u.prototype._getViewRectInTable=function(){var e=this,t=e.gameObject,n=t.rect,r=e.content;return r?new qc.Rectangle(n.x-e.extraLeft-r.x,n.y-e.extraTop-r.y,n.width+e.extraLeft+e.extraRight,n.height+e.extraTop+e.extraBottom):new qc.Rectangle(0,0,0,0)},u.prototype._setCellRect=function(e,t,n,r,i){var s=this,o=s.content;if(!o||!e)return;e.x=t,e.y=n,e.width=r,e.height=i},u.prototype._rebuildTable=function(){var e=this,t=e.adapter,n=e.content;if(!n)return;if(!t){this._clearTable();return}var r=t.getTableSize();if(r.x<=0||r.y<=0||r.x===Infinity&&r.y===Infinity){this._clearTable();return}var i=e._getViewRectInTable(),s=e._showRect,o=i.x,u=i.x+i.width,a=i.y,f=i.y+i.height,l=t.findCellWithPos(o,a),c=t.findCellWithPos(u,f);if(!e.overflow){var h=t.findCellWithPos(o-1,a-1),p=t.findCellWithPos(u+1,f+1);h.x===l.x&&++l.x,h.y===l.y&&++l.y,p.x===c.x&&--c.x,p.y===c.y&&--c.y}var d=Math.max(l.x,0),v=Math.max(l.y,0),m=Math.min(c.x,r.x-1),g=Math.min(c.y,r.y-1),y=n.children,b=s.width*s.height;b!==y.length&&(n.removeChildren(),s.setTo(0,0,0,0),b=0);var w,E,S,x,T,N=b-1;for(E=s.y+s.height-1,x=s.y;E>=x;--E)for(S=s.x+s.width-1,T=s.x;S>=T;--S,--N){if(S>=d&&S<=m&&E>=v&&E<=g)continue;w=n.removeChildAt(N),t.revokeCell(w,S,E),e._revokeCell(w)}var C=Math.max(s.x,d),k=Math.max(s.y,v),L=Math.min(s.x+s.width-1,m),A=Math.min(s.y+s.height-1,g),O=m-d+1,M=g-v+1;if(O>0&&M>0){N=0;for(E=v;E<=g;++E)for(S=d;S<=m;++S,++N){if(S>=C&&S<=L&&E>=k&&E<=A)continue;w=e._createCell();if(!w)continue;n.addChildAt(w,N);var _=t.getCellRect(S,E);e._setCellRect(w,_.x,_.y,_.width,_.height),t.createCell(w,S,E)}}s.setTo(d,v,O,M)},u.prototype._doChildrenChanged=function(e){this._needRebuild=!0},u.prototype._doLayoutArgumentChanged=function(){this._needRebuild=!0};var a=qc.defineBehaviour("qc.TweenFunction",qc.Tween,function(){var e=this;e.funcName="",e.func=null,e.funcContext=null,e.enable=!1},{funcName:qc.Serializer.STRING});a.__menu="Plugins/TweenFunction",t.defineProperties(a.prototype,{funcName:{get:function(){return this._funcName},set:function(e){if(e===this._funcName)return;this._funcName=e,this.onEnable()}}}),a.prototype.onEnable=function(){if(this._funcName.length<=0)return;this.func=this.gameObject[this._funcName];var t=[];this.func&&(t.push(this.gameObject.class),this.func=this.func.bind(this.gameObject));var n=this;this.gameObject.scripts.forEach(function(e){var r=e[n._funcName];r&&(t.push(e.class),n.func=r.bind(e))}),!n.func&&this.enable&&this.game.log.important("TweenFunction({0}) not find!",this._funcName);if(t.length<=1)return;n.game.log.error("Error: Exist multi functions with same name: {0}",t);if(n.game.device.editor===!0){var r=e.parent&&e.parent.G;if(r){var i=r._("TweenFunction func error")+t;r.notification.error(i)}}},a.prototype.onUpdate=function(e,t){if(typeof this.func!="function")return;if(this.duration==0&&!t)return;this.func(e,this.duration)},a.begin=function(e,t,n){var r=qc.Tween.begin("qc.TweenFunction",e,t);return r.funcName=n,r};var f={};f.randomByWeight=function(e){var t,n,r=0,i=e.length;for(t=0;t<i;t++)r+=e[t];var n=f.random(r-1);r=0;for(t=0;t<i;t++){r+=e[t];if(n<r)return t}},f.random=function(e,t){return t==null&&(t=e,e=0),e+Math.floor(Math.random()*(t-e+1))},f.map=function(e,t){var n=e.length,r=Array(n);for(var i=0;i<n;i++)r[i]=t(e[i],i,e);return r},f.calcPercentageByScore=function(e){return e<3e3?5:e<1e4?16:e<1e5?31:e<1e6?31+Math.floor((e-1e5)/1e5)*5:e<2e7?70+Math.floor((e-1e6)/2e6)*2:Math.min(99,91+Math.floor((e-2e7)/5e6)*1)},f.calcRankByScore=function(e){return e<1e5?1:e<1e6?2:e<5e6?3:e<2e7?4:e<1e8?5:6},f.toText=function(e){var t="";while(e>=1e3)t=","+("00"+e%1e3).slice(-3)+t,e=Math.floor(e/1e3);return t=""+e+t,t};var l=qc.defineBehaviour("qc.engine.highCityMedalEffect",qc.Behaviour,function(){},{background:qc.Serializer.NODE,level:qc.Serializer.NODE,workerIcon:qc.Serializer.NODE,workerAddon:qc.Serializer.NODE,workerNum:qc.Serializer.NODE});l.prototype.awake=function(){},l.prototype.play=function(e){var t=this,n=g.config.city[e].token;t.gameObject.visible=!0,n>0?(t.background.frame="mircle.png",t.workerIcon.visible=!0,t.workerAddon.text="+"+n,g.game.timer.add(g.config.timeoutAddWorkerWhenMedal,function(){t.workerNum.getScript("qc.engine.WorkerAdd").addByCityLevel(n)})):(t.background.frame="silver.png",t.workerIcon.visible=!1,t.workerAddon.text=""),t.level.text="L"+e;var r=t.gameObject.getScript("qc.TweenScale");r.resetGroupToBeginning(),r.playGroupForward(),g.game.timer.add(1e3*r.duration,function(){t.gameObject.visible=!1})};var c=function(){this.tempdata={},g.e.add(function(e){if(e!=="restoreData")return;this.restore()},this)};c.prototype.constructor=c,c.prototype.queryUser=function(e){return this.userdata[e]},c.prototype.setUser=function(e,t){this.userdata[e]=t,this.save()},c.prototype.queryGame=function(e){return this.gamedata[e]},c.prototype.setGame=function(e,t){this.gamedata[e]=t,this.save()},c.prototype.queryTemp=function(e){return this.tempdata[e]},c.prototype.setTemp=function(e,t){this.tempdata[e]=t},c.prototype.save=function(){try{var t=JSON.stringify(this.userdata)+"_SubaraCity_"+JSON.stringify(this.gamedata);g.game.storage.set("SubaraCityToken_"+this.rid,e.md5(t)),g.game.storage.save()}catch(n){}},c.prototype.restore=function(){var t="user_"+this.rid;userData=g.game.storage.get(t),userData?this.userdata=userData:g.game.storage.set(t,this.userdata={});var n="game_"+this.rid;gamedata=g.game.storage.get(n),gamedata?this.gamedata=gamedata:g.game.storage.set(n,this.gamedata={});var r=g.game.storage.get("SubaraCityToken_"+this.rid),i=JSON.stringify(this.userdata)+"_SubaraCity_"+JSON.stringify(this.gamedata);i=e.md5(i);if(r===i)return;g.game.storage.set(t,this.userdata={}),g.game.storage.set(n,this.gamedata={}),this.save()},c.prototype.updateScore=function(){var e=g.me.queryUser("best")||0;if(g.city.population<e)return;g.me.setUser("best",g.city.population);if(!this.userInfo)return;qc.Interactive.updateScorers(this.rid,this.token,g.city.population,function(e){console.info("更新记录成功！")})};var h=function(){var e=this;g.e.add(function(t,n){switch(t){case"newGame":e.onNewGame();break;case"yearChanged":e.onYearChanged(n);break;case"newCity":e.onNewCity(n);break;default:}})};h.prototype.constructor=h,h.prototype.onNewGame=function(e){this.setGuideIndex(g.city.guideIndex||0)},h.prototype.onYearChanged=function(e){var t=this;if(t.waitKey!=="YEAR")return;t.yearPass++,t.yearPass>=t.waitPara&&t.setGuideIndex(t.guideIndex+1)},h.prototype.onNewCity=function(e){var t=this;if(t.waitKey!=="CITY")return;if(e<t.waitPara)return;t.setGuideIndex(t.guideIndex+1)},h.prototype.setGuideIndex=function(e){var t=this;g.city.guideIndex=t.guideIndex=e,t.yearPass=0,t.guideTint=g.config.guide[e].tint;var n=g.config.guide[e+1]||{};t.waitKey=n.key,t.waitPara=n.para},h.prototype.getTint=function(){return this.guideTint||""};var p=function(e){this.id=e.id*1,this.min=e.min*1,this.max=e.max*1||Infinity,this.content=e.content},d=function(e){this.shareMap={};var t=e.findSheet("share");for(var n in t.rows){var r=t.rows[n];this.shareMap[r.id]=new p(r)}};d.prototype={},d.prototype.constructor=d,d.prototype.getContent=function(e){if(e===0)return this.shareMap[0].content;for(var t in this.shareMap){var n=this.shareMap[t];if(e>n.min&&e<=n.max)return n.content.replace("{0}",e)}};var v=function(){};v.prototype.constructor=v,v.prototype.setBusy=function(e){g.me.setTemp("statusBusy",e)},v.prototype.isBusy=function(){return g.me.queryTemp("statusBusy")===!0},v.prototype.isGaming=function(){return g.me.queryTemp("gaming")===!0},v.prototype.setGaming=function(e){g.me.setTemp("gaming",e)};var m=qc.defineBehaviour("qc.Interactive",qc.Behaviour,function(){qc.interactive=this},{gameName:qc.Serializer.STRING,serverUrl:qc.Serializer.STRING});m.updateScorers=function(e,t,n,r,i){var s=qc.interactive.serverUrl+"updateScorers03.php";s+="?rid="+e,s+="&token="+t,s+="&scorers="+n,s+="&gameName="+qc.interactive.gameName,qc.AssetUtil.get(s,r,i)},m.getRank=function(e,t,n,r,i){var s=qc.interactive.serverUrl+"getRank03.php";s+="?rid="+e,s+="&token="+t,s+="&channel="+n,s+="&gameName="+qc.interactive.gameName,qc.AssetUtil.get(s,r,i)};var g=e.C={};qc.initGame=function(e){e.log.trace("Game init."),e.C=g,g.game=e,g.e=new qc.Signal,g.uiEvent=new qc.Signal,g.config=new z,g.me=new c,g.city=new A,g.status=new v,g.guide=new h,g.achievement=new U,g.e.dispatch("worldPrepare"),g.e.dispatch("worldInit"),g.e.dispatch("worldOK")};var y=qc.defineBehaviour("qc.engine.BatchDraw",qc.Behaviour,function(){},{});y.prototype.awake=function(){this.gameObject.phaser._renderWebGL=this.renderWebGL},y.prototype.update=function(){},y.prototype.renderWebGL=function(e){if(!this.visible||this.alpha<=0)return;var t=e.spriteBatch;t.render(this);var n,r=this.children,i,s,o=r.length,u=Array(o),a=0;for(n=0;n<o;n++){i=r[n];if(!i.visible||i.alpha<=0)continue;u[a++]=s=i.children,s[0]._renderWebGL(e)}for(n=0;n<a;n++)s=u[n],s[1]._renderWebGL(e),s[2]._renderWebGL(e);for(n=0;n<a;n++)s=u[n],s[3]._renderWebGL(e)};var b=qc.defineBehaviour("SubaraCity.Block",qc.Behaviour,function(){this.x=0,this.y=0},{bgImage:qc.Serializer.NODE,cityImage:qc.Serializer.NODE,highHintImage:qc.Serializer.NODE,shadowImage:qc.Serializer.NODE});b.prototype.awake=function(){var e=this;this.cityImage.scripts.forEach(function(t){t.flag==="tweenScalePassby"&&(e.scriptTweenScalePassby=t),t.flag==="tweenScaleFinal"&&(e.scriptTweenScaleFinal=t)})},b.prototype.update=function(){},b.prototype.setPosition=function(e,t,n){this.x=e,this.y=t,this.key=g.city.locateKey(e,t),this.gameObject.x=this.x*g.config.blockSize,this.gameObject.y=this.y*g.config.blockSize,this.adjustGround(n),this.adjustCity()},b.prototype.getKey=function(){return this.key},b.prototype.initDropdownInfo=function(e){this.x=g.city.locateXByKey(e),this.y=g.city.locateYByKey(e),this.key=e},b.prototype.initNewBlockDrop=function(e,t){this.getScript("qc.TweenPosition").stop(),this.x=g.city.locateXByKey(t),this.y=g.city.locateYByKey(t),this.key=t,this.gameObject.x=this.x*g.config.blockSize,this.gameObject.y=e*g.config.blockSize,this.adjustGround(!1),this.adjustCity()},b.prototype.resetPosFromLogicalY=function(e){if(e<-1)return;this.gameObject.visible=!0,this.gameObject.y=e*g.config.blockSize},b.prototype.mergeToKey=function(e){this.clearConnection(),this.cityImage.visible=!1;var t=g.config.blockFadeoutTime,n=this.getScript("qc.TweenPosition");n.from=new qc.Point(this.gameObject.x,this.gameObject.y);var r=g.city.locateXByKey(e),i=g.city.locateYByKey(e);n.to=new qc.Point(r*g.config.blockSize,i*g.config.blockSize),n.duration=.001*t,n.resetToBeginning(),n.playForward()},b.prototype.playCityUpgradeAnimation=function(e,t){var n=this,r=n.gameObject.parent.getScript("SubaraCity.Board"),i,s=0,o=n.gameObject.x,u=n.gameObject.y;for(i=t+1;i<e;i++)(function(e,t){g.game.timer.add(t,function(){n.adjustCity(e),n.scriptTweenScalePassby.resetToBeginning(),n.scriptTweenScalePassby.playGroup(),g.uiEvent.dispatch("cityUpgrade",o,u,e),e>g.config.maxCityLevelByScore&&(n.bgImage.frame=g.config.blockTypeWhenMaxScore+1<<4)})})(i,s*1e3*n.scriptTweenScalePassby.duration),s++;var a=s*1e3*n.scriptTweenScalePassby.duration;g.game.timer.add(a,function(){n.adjustCity(e),n.scriptTweenScaleFinal.resetToBeginning(),n.scriptTweenScaleFinal.playGroup(),e!==t&&g.uiEvent.dispatch("cityUpgrade",o,u,e),e===g.config.maxCityLevelByScore?n.bgImage.frame=g.config.blockTypeWhenMaxScore<<4:e>g.config.maxCityLevelByScore&&(n.bgImage.frame=g.config.blockTypeWhenMaxScore+1<<4)}),g.game.timer.add(a+g.config.cityFinalScalePending,function(){r.cityAniEvent.dispatch("cityUpdated")})},b.prototype.clearConnection=function(e){e=e||15,this.bgImage.frame=this.bgImage.frame&~e},b.prototype.adjustCity=function(e){var t=this.key,n=g.city.getBlockInfoByKey(t);if(!e)if(n.level)e=n.level;else{var r=n.score;e=g.city.calcCityLevelByScore(r)}var i;if(e===1){var s=n.subScore;i="level"+e+"_"+(s+1)+".png"}else i="level"+e+".png";this.cityImage.frame=i,this.cityImage.resetNativeSize();var o=g.config.city[e],u,a;e===1?(u=o.shiftX[s],a=o.shiftY[s]):(u=o.shiftX,a=o.shiftY),this.cityImage.pivotX=u/this.cityImage.width,this.cityImage.pivotY=a/this.cityImage.height,this.cityImage.visible=!0},b.prototype.hiddenConnection=function(e){var t=parseInt(this.bgImage.frame);t&=~(1<<e),this.bgImage.frame=t},b.prototype.adjustGround=function(e){var t=0,n=this.key,r=g.city.getBlockInfoByKey(n,"type");t|=r<<4;if(e!==!1&&r!==g.config.blockTypeFinal){var i=typeof e=="function",s,o;for(s=0;s<4;s++){o=n+A.MOVEMENTS[s];if(i&&e(n,o)===!1)continue;g.city.getBlockInfoByKey(o,"type")===r&&(t|=1<<s)}}this.bgImage.frame=t},b.prototype.doHighCityHint=function(){this.highHintImage.visible=!0;var e=Math.round(this.bgImage.frame);this.highHintImage.frame=g.config.blockTypeWhenMaxScore+1<<4|e&15;var t=this.highHintImage.getScript("qc.TweenAlpha");t.resetToBeginning(),t.playForward()},b.prototype.hideHighCityHint=function(){this.highHintImage.visible=!1};var w=qc.defineBehaviour("SubaraCity.Board",qc.Behaviour,function(){this.cityAniEvent=new qc.Signal},{blockPrefab:qc.Serializer.PREFAB,populationNode:qc.Serializer.NODE,boomNode:qc.Serializer.NODE,highCityMedalEffect:qc.Serializer.NODE});w.prototype.getControllerByKey=function(e){var t,n=this.blockCtrollers,r,i=n.length;for(r=0;r<i;r++){t=n[r];if(t.key===e)return t}},w.prototype.awake=function(){var e=this;g.board=e,this.gameObject.scripts.forEach(function(t){t.flag==="tweenDown"&&(e.tweenDownScript=t,e.tweenDownDuration=1e3*t.duration),t.flag==="tweenShake"&&(e.tweenShakeScript=t,e.tweenShakeDuration=1e3*t.duration)}),e.boomDuration=1e3*e.boomNode.getAnimationInfo("start").duration,e.boomShiftX=e.boomNode.x,e.boomShiftY=e.boomNode.y,g.e.add(function(t){t==="newGame"&&g.game.timer.add(1,function(){e.createBoard()})}),e.cityAniEvent.add(function(t){switch(t){case"prepareMerge":e.playMergeAnimation();break;case"prepareDestroy":e.playDestoryAnimation();break;case"blockMerged":e.playCityUpgradeAnimation();break;case"cityUpdated":e.playMedalEffect();break;case"medalEffectPlayed":e.playDropDownAnimation();break;case"blockDroped":e.playScoreAnimation();break;case"scorePlayed":g.status.setBusy(!1),g.game.time.frameRate=e.frameRate,g.uiEvent.dispatch("animationEnd")}})},w.prototype.createBoard=function(){var e,t,n,r,i=this;i.gameObject.children.forEach(function(e){e.destroyImmediately()}),i.populationNode.text=f.toText(0),i.blockCtrollers=[],i.shadows=[];var s={};for(t=0;t<g.config.boardSize;t++)for(e=0;e<g.config.boardSize;e++)n=g.game.add.clone(i.blockPrefab,i.gameObject),r=n.getScript("SubaraCity.Block"),i.shadows.push(r.shadowImage),r.setPosition(e,t,15),i.blockCtrollers.push(r),n.visible=!1,s[g.city.locateKey(e,t)]={from:t-g.config.initDropDownNumber,to:g.city.locateKey(e,t)};g.uiEvent.dispatch("restart"),i.playAnimation({movement:{},newBlock:s,lastPopulation:0,newGame:!0})},w.prototype.playAnimation=function(e){g.status.setBusy(!0);var t=this;t.cityAniEventContext=e,t.frameRate=g.game.time.frameRate,g.game.time.frameRate=100,g.uiEvent.dispatch("animationStart"),e.newGame?g.game.timer.add(g.config.initDropDownPending,function(){t.cityAniEvent.dispatch("medalEffectPlayed")}):e.destroy?t.cityAniEvent.dispatch("prepareDestroy"):t.cityAniEvent.dispatch("prepareMerge")},w.prototype.playMergeAnimation=function(){var e=this,t=e.cityAniEventContext.connection,n,r=t[0],i=e.blockCtrollers,s=i.length,o,u;for(n=0;n<s;n++)o=i[n],u=t.indexOf(o.getKey()),u>0?(o.gameObject.parent.setChildIndex(0),o.mergeToKey(r)):u===0&&o.clearConnection();g.game.timer.add(g.config.blockFadeoutTime,function(){e.cityAniEvent.dispatch("blockMerged")})},w.prototype.playDestoryAnimation=function(){var e=this;e.boomNode.visible=!0;var t=e.cityAniEventContext.x,n=e.cityAniEventContext.y,r=e.getControllerByKey(g.city.locateKey(t,n));r.gameObject.visible=!1,e.boomNode.x=e.boomShiftX+t*g.config.blockSize,e.boomNode.y=e.boomShiftY+n*g.config.blockSize,e.boomNode.playAnimation("start"),g.game.timer.add(e.boomDuration,function(){e.boomNode.visible=!1,e.cityAniEvent.dispatch("cityUpdated")})},w.prototype.playCityUpgradeAnimation=function(){var e=this,t=e.cityAniEventContext.connection,n,r=t[0],i=e.blockCtrollers,s=i.length,o,u,a;for(n=0;n<s;n++)o=i[n],u=t.indexOf(o.getKey()),u>0?o.gameObject.visible=!1:u===0&&(a=o);a.playCityUpgradeAnimation(e.cityAniEventContext.cityLevel,e.cityAniEventContext.lastMaxCityLevel)},w.prototype.playMedalEffect=function(){var e=this,t=e.cityAniEventContext.cityLevel;if(!t||t<=g.config.maxCityLevelByScore){e.cityAniEvent.dispatch("medalEffectPlayed");return}e.highCityMedalEffect.getScript("qc.engine.highCityMedalEffect").play(t),g.game.timer.add(g.config.medalEffectPending,function(){e.cityAniEvent.dispatch("medalEffectPlayed");return})},w.prototype.playDropDownAnimation=function(){var e=this,t,n,r,i,s,o=e.cityAniEventContext.movement,u=e.cityAniEventContext.newBlock,a,f,l,c,h=0,p={};for(t=0,n=e.blockCtrollers.length;t<n;t++)r=e.blockCtrollers[t],i=r.key,s=o[i],typeof s=="number"?i!==s?(f=g.city.locateYByKey(r.key),l=g.city.locateYByKey(s),r.initDropdownInfo(s)):f=l=g.city.locateYByKey(s):(a=u[i],f=a.from,l=g.city.locateYByKey(a.to),r.initNewBlockDrop(a.from,a.to)),c=l-f,p[c]||(p[c]=[]),p[c].push({controller:r,from:f,to:l}),c>h&&(h=c);g.game.log.trace("Drop times : {0}",h),e.dropDownContext={times:0,maxTimes:h,group:p},e._isDroping=!0,e.dropOneStep()},w.prototype.dropOneStep=function(){var e=this,t=e.tweenDownScript;t.resetToBeginning(),t.playForward();var n=e.dropDownContext,r=n.times,i=n.group,s=i[r]||[],o,u,a,f,l={},c={},h,p,d;for(o=0,u=s.length;o<u;o++)h=s[o].controller,l[g.city.locateKey(h.x,h.y)]=h;for(a=r+1;a<=n.maxTimes;a++){s=i[a];if(!s)continue;for(o=0,u=s.length;o<u;o++)h=s[o].controller,c[g.city.locateKey(h.x,s[o].from+r)]=h}for(f in l)p=parseInt(f)+A.MOVEMENTS[A.DIR_LEFT],c[p]&&(l[f].hiddenConnection(A.DIR_LEFT),c[p].hiddenConnection(A.DIR_RIGHT)),d=parseInt(f)+A.MOVEMENTS[A.DIR_RIGHT],c[d]&&(l[f].hiddenConnection(A.DIR_RIGHT),c[d].hiddenConnection(A.DIR_LEFT));g.game.timer.add(e.tweenDownDuration,function(){e.dropDownContext.times++;var t=e.tweenShakeScript;t.resetToBeginning(),t.playForward(),e.dropDownContext.times<e.dropDownContext.maxTimes?e.dropOneStep():g.game.timer.add(e.tweenShakeDuration,function(){e._isDroping=!1;var t=e.gameObject.children,n,r,i=0;for(r=0;r<g.config.boardSize;r++)for(n=0;n<g.config.boardSize;n++)t[i++].getScript("SubaraCity.Block").setPosition(n,r);e.cityAniEvent.dispatch("blockDroped")})})},w.prototype.playScoreAnimation=function(){var e=this,t=this.populationNode.getScript("qc.TweenText"),n=t.duration;t.from=e.cityAniEventContext.lastPopulation,t.to=g.city.population,t.resetGroupToBeginning(),t.playGroup();var r=0;g.game.timer.add(r,function(){e.cityAniEvent.dispatch("scorePlayed")})},w.prototype.tweenDownCallback=function(e){if(!this._isDroping)return;var t=this,n=t.dropDownContext,r=n.times,i,s,o,u=n.group,a;for(i=r+1;i<=n.maxTimes;i++){a=u[i];if(!a)continue;o=a.length;for(s=0;s<o;s++)a[s].controller.resetPosFromLogicalY(a[s].from+r+e)}},w.prototype.tweenShakeCallback=function(e){if(!this._isDroping)return;var t=this,n=t.dropDownContext,r=n.times;if(r<1)return;var i,s,o=n.group,u;u=o[r];if(!u)return;s=u.length;for(i=0;i<s;i++)u[i].controller.resetPosFromLogicalY(u[i].from+r+e)};var E=qc.defineBehaviour("qc.engine.BuildingMenu",qc.Behaviour,function(){},{closeBtn:qc.Serializer.NODE,buildingRoot:qc.Serializer.NODE});E.prototype.awake=function(){var e=this;e.addListener(e.closeBtn.onClick,e.close,e)},E.prototype.show=function(){var e=this;g.status.setBusy(!0),e.gameObject.parent.visible=!0,e.gameObject.visible=!0,e.buildingRoot.children.forEach(function(e){var t=parseInt(e.name.slice(5)),n=e.find("scale1"),r=e.find("工人");g.achievement.isLevelReach(t)?(n&&(n.visible=!0),r&&(r.visible=!0)):(n&&(n.visible=!1),r&&(r.visible=!1))})},E.prototype.close=function(){var e=this;e.gameObject.visible=!1,e.gameObject.parent.visible=!1,g.status.setBusy(!1)};var S=qc.defineBehaviour("qc.engine.CityLevelFly",qc.Behaviour,function(){},{});S.prototype.awake=function(){var e=this;e.alphaCtrl=e.getScript("qc.TweenAlpha"),e.posCtrl=e.getScript("qc.TweenPosition"),e.duration=1e3*Math.max(e.alphaCtrl.duration,e.posCtrl.duration),e.shiftX=this.gameObject.x,e.posTweenFrom=e.posCtrl.from.y,e.posTweenTo=e.posCtrl.to.y,g.uiEvent.add(function(t,n,r,i){if(t!=="cityUpgrade")return;e.showText(n,r,i)})},S.prototype.showText=function(e,t,n){var r=this;r.gameObject.visible=!0,r.timerId&&g.game.timer.remove(r.timerId),r.gameObject.x=r.shiftX+e,r.gameObject.text="L"+n,r.posCtrl.from.y=r.posTweenFrom+t,r.posCtrl.to.y=r.posTweenTo+t,r.posCtrl.resetGroupToBeginning(),r.posCtrl.playGroup(),r.timerId=g.game.timer.add(r.duration,function(){r.gameObject.visible=!1})};var T=qc.defineBehaviour("qc.engine.DeadMenu",qc.Behaviour,function(){},{background:qc.Serializer.NODE,firework:qc.Serializer.NODE,rankIcon:qc.Serializer.NODE,textGroup:qc.Serializer.NODE,text:qc.Serializer.NODE,yearLabel:qc.Serializer.NODE,yearUnit:qc.Serializer.NODE,beatLabel:qc.Serializer.NODE,currScore:qc.Serializer.NODE,bestScore:qc.Serializer.NODE,newIcon:qc.Serializer.NODE,btnGroup:qc.Serializer.NODE,restartBtn:qc.Serializer.NODE,shareBtn:qc.Serializer.NODE});T.prototype.awake=function(){var e=this;g.uiEvent.add(function(t){t==="animationEnd"&&g.city.dead?e.redraw():(t==="rankingClose"||t==="followMsgClose")&&arguments[1]===e.class&&e.show()}),e.addListener(e.shareBtn.onClick,e.doShare,e),e.addListener(e.restartBtn.onClick,function(){if(!e.canClick){g.game.log.trace("can not click right now.");return}e.hide(),g.game.log.trace("new game!!!"),g.city.newCity(),e.background.visible=!1}),e.gameObject.visible=!1,e.background.visible=!1,e.canClickDuration=e.btnGroup.getScript("qc.TweenPosition").duration},T.prototype.update=function(){this.yearUnit.anchoredX=this.yearLabel.textRealWidth+this.yearLabel.anchoredX;if(!this.newIcon.visible)return;this.newIcon.anchoredX=this.bestScore.textRealWidth+this.bestScore.anchoredX-5},T.prototype.redraw=function(){g.me.updateScore();var e=this;g.status.setBusy(!0),e.gameObject.visible=!0,e.canClick=!1,e.firework.playAnimation("action");var t=g.city.population,n=f.calcRankByScore(t),r=f.calcPercentageByScore(t);e.rankIcon.frame="rank"+n+".png";var i=g.config["deadContentRank"+n];e.text.text=i,e.beatLabel.text="击败了全球"+r+"%的玩家",e.yearLabel.text=g.city.year+"",e.currScore.text=f.toText(t);var s=g.me.queryUser("best")||0;e.bestScore.text=f.toText(s),e.newIcon.visible=!1,e.newIcon.visible=s===t,e.textGroup.visible=!1,e.rankIcon.visible=!1,e.btnGroup.visible=!1,g.game.timer.add(g.config.fireworkPendingTimeout,function(){e.textGroup.visible=!0,e.rankIcon.visible=!0,e.btnGroup.visible=!0,e.background.visible=!0,qc.Tween.resetGroupToBeginning(e.gameObject,1),qc.Tween.playGroupForward(e.gameObject,1),g.game.timer.add(e.canClickDuration,function(){e.canClick=!0})})},T.prototype.doShare=function(){if(!this.canClick)return;g.uiEvent.dispatch("showShareMask",this.class)},T.prototype.hide=function(){this.gameObject.visible=!1},T.prototype.show=function(){this.gameObject.visible=!0};var N=qc.defineBehaviour("SubaraCity.FollowMsg",qc.Behaviour,function(){this._dispatchClass=""},{title:qc.Serializer.NODE,closeBtn:qc.Serializer.NODE,followBtn:qc.Serializer.NODE});N.prototype.awake=function(){this.addListener(this.closeBtn.onClick,this.close,this),this.addListener(this.followBtn.onClick,this.doFollow,this),this.addListener(g.uiEvent,function(e){e==="showFollowMsg"&&this.show(arguments[1])},this)},N.prototype.show=function(e){this._dispatchClass=e,this.gameObject.visible=!0,g.me.rid?g.me.subscribe||(this.title.text="亲，你要[#FF0000]关注公众号[-]后才能查看排行榜哦！"):this.title.text="亲，你要[#FF0000]关注公众号[-]并通过[#FF0000]微信登录[-]，才能查看排行榜哦！";var t=this;g.status.setBusy(!0),t.gameObject.parent.visible=!0,t.gameObject.visible=!0,t.canClick=!1;var n=t.getScript("qc.TweenPosition");n.resetToBeginning(),n.playForward(),g.game.timer.add(n.duration*1e3,function(){t.canClick=!0})},N.prototype.close=function(){var e=this;e.canClick=!1;var t=e.getScript("qc.TweenPosition");t.resetToBeginning(!0),t.playReverse(),g.game.timer.add(t.duration*1e3,function(){e.shutdown(),g.uiEvent.dispatch("followMsgClose",e._dispatchClass)})},N.prototype.shutdown=function(){var e=this;e.gameObject.visible=!1,e.gameObject.parent.visible=!1,g.status.setBusy(!1)},N.prototype.doFollow=function(){document.location.href=g.config.followHref};var C=qc.defineBehaviour("qc.engine.GuideMenu",qc.Behaviour,function(){},{guides:qc.Serializer.NODES,closeButtons:qc.Serializer.NODES});C.prototype.awake=function(){var e=this,t,n=e.closeButtons.length;for(t=0;t<n;t++)(function(t){e.addListener(e.closeButtons[t].onClick,function(){e.onClose(t)})})(t);g.uiEvent.add(function(t,n){if(t!=="guideMenuShow")return;e.show(n)})},C.prototype.onClose=function(e){var t=this;if(!t.canClick)return;var n=t.getScript("qc.TweenFunction");n.resetToBeginning(!0),n.playReverse(),t.canClick=!1,g.game.timer.add(1e3*n.duration,function(){t.canClick=!0,t.currentGuide.visible=!1,t.doShow(t.showIndex+1)})},C.prototype.onTweenYPosition=function(e){var t=this;if(!t.currentGuide)return;t.currentGuide.y=-t.currentGuide.height*(1-e)},C.prototype.hide=function(){var e=this;e.gameObject.visible=!1,e.gameObject.parent.visible=!1,delete e.currentGuide,g.status.setBusy(!1)},C.prototype.show=function(e){var t,n,r=this;if(!e){e=[];for(t=0,n=r.closeButtons.length;t<n;t++)e.push(t)}r.gameObject.parent.visible=!0,r.gameObject.visible=!0,r.showOrder=e,g.status.setBusy(!0),r.doShow(0)},C.prototype.doShow=function(e){var t=this;if(e<0||e>=t.showOrder.length){t.hide();return}t.showIndex=e;var n=t.guides[t.showOrder[e]];t.currentGuide=n,n.visible=!0,n.y=-n.height;var r=t.getScript("qc.TweenFunction");r.resetToBeginning(),r.playForward(),t.canClick=!1,g.game.timer.add(1e3*r.duration,function(){t.canClick=!0})};var k=qc.defineBehaviour("qc.engine.GuideText",qc.Behaviour,function(){},{});k.prototype.awake=function(){var e=this;g.uiEvent.add(function(t,n,r,i){if(t!=="animationEnd")return;e.redraw()})},k.prototype.redraw=function(e,t){var n;g.city.hopeless&&!g.city.dead?n=g.config.dieGuide:n=g.guide.getTint();if(this.gameObject.text===n)return;this.gameObject.text=n;var r=this.gameObject.getScript("qc.TweenAlpha");r.resetToBeginning(),r.playForward()};var L=qc.defineBehaviour("SubaraCity.HighCityHint",qc.Behaviour,function(){},{});L.prototype.awake=function(){var e=this;g.uiEvent.add(function(t){t==="animationEnd"||t==="restart"?e.redraw():t==="animationStart"&&e.hidden()})},L.prototype.redraw=function(){var e={},t,n,r,i,s=0,o,u,a,f;for(r=0;r<g.config.boardSize;r++)for(i=0;i<g.config.boardSize;i++){u=g.city.locateKey(r,i);if(e[u])continue;a=g.city.maxConnectionDetect(r,i),t=a.length;for(n=0;n<t;n++)e[a[n]]=!0;if(t<=1)continue;if(g.city.getBlockInfoByKey(u,"type")===g.config.blockTypeWhenMaxScore)continue;s=0;for(n=0;n<t;n++)s+=g.city.getBlockInfoByKey(a[n],"score");f=g.city.calcCityLevelByScore(s);if(f<g.config.maxCityLevelByScore)continue;o?Array.prototype.push.apply(o,a):o=a}if(!o)return;var l=g.board.blockCtrollers,c;t=l.length;for(n=0;n<t;n++)c=l[n],o.indexOf(c.key)>=0&&l[n].doHighCityHint()},L.prototype.hidden=function(){var e=g.board.blockCtrollers,t=e.length,n;for(n=0;n<t;n++)e[n].hideHighCityHint()};var A=function(){var e=this;[[0,-1],[1,0],[0,1],[-1,0]].forEach(function(t){A.MOVEMENTS.push(e.locateKey(t[0],t[1]))}),g.e.add(function(t){t==="restoreFromStorage"&&e.tryRestoreFromStorage()})};A.prototype.constructor=A,A.DIR_UP=0,A.DIR_RIGHT=1,A.DIR_DOWN=2,A.DIR_LEFT=3,A.MOVEMENTS=[],A.prototype.newCity=function(){var e,t,n=this;n.setToken(g.config.initToken),n.passYear=0,n.year=g.config.initYear,n.board={};for(t=0;t<g.config.boardSize;t++)for(e=0;e<g.config.boardSize;e++)n.initBlock(e,t);n.guideIndex=0,n.newYearComing(g.config.initYear),g.status.setBusy(!1),g.status.setGaming(!0),g.e.dispatch("newGame")},A.prototype.tryRestoreFromStorage=function(){var e=g.me.queryGame("city");if(!e){this.newCity();return}var t=g.config.boardSize,n=3+t*t*4;if(e.length!==n)return;var r=this,i,s,o,u;i=3,r.board={};for(s=0;s<t;s++)for(o=0;o<t;o++)u=this.board[r.locateKey(s,o)],r.setBlockInfo(s,o,null,{score:e[i],level:e[i+1],type:e[i+2],subScore:e[i+3]}),i+=4;r.setYear(g.config.initYear+e[0]),r.setToken(e[1]),r.guideIndex=e[2],r.calcPopulation(),r.hopeless=r.isHopeless(),r.dead=r.hopeless&&this.token<=0,g.status.setGaming(!0),g.e.dispatch("newGame")},A.prototype.saveToStorage=function(){var e=this,t=g.config.boardSize,n=3+t*t*4,r=Array(n),i=0,s,o,u;r[i++]=e.year-g.config.initYear,r[i++]=e.token,r[i++]=e.guideIndex||0;for(s=0;s<t;s++)for(o=0;o<t;o++)u=this.board[e.locateKey(s,o)],r[i++]=u.score,r[i++]=u.level,r[i++]=u.type,r[i++]=u.subScore||0;g.me.setGame("city",r)},A.prototype.setToken=function(e){this.token=e,g.e.dispatch("tokenChanged",e)},A.prototype.setYear=function(e){this.year=e;var t=this.year-g.config.initYear;t&&(!this.passYear||t>this.passYear)&&(this.passYear=t,t%g.config.yearsAddToken===0&&this.setToken(this.token+1)),g.e.dispatch("yearChanged",e)},A.prototype.calcPopulation=function(){var e=0,t=this,n,r,i;for(n in t.board)r=t.board[n],i=r.level,i||(i=t.calcCityLevelByScore(r.score)),e+=g.config.city[i].population;this.population=e},A.prototype.initBlock=function(e,t,n){var r=this.generateOneBlock(),i=this.generateInitScore(n),s={type:r,score:i,level:0};return this.calcCityLevelByScore(i)===1&&(s.subScore=f.random(g.config.level1SubType-1)),this.setBlockInfo(e,t,null,s),s},A.prototype.getBlockInfoByKey=function(e,t){var n=this.board[e]||{};return t?n[t]:n},A.prototype.getBlockInfo=function(e,t,n){var r=this.locateKey(e,t),i=this.board[r]||{};return n?i[n]:i},A.prototype.setBlockInfoByKey=function(e,t,n){if(!t){this.board[e]=n;return}var r=this.board[e];r||(this.board=r={}),r[t]=n},A.prototype.setBlockInfo=function(e,t,n,r){var i=this.locateKey(e,t);return this.setBlockInfoByKey(i,n,r)},A.prototype.generateOneBlock=function(){var e;return this.year>=g.config.newGroundYear?e=g.config.newGroundWeight[1]:e=g.config.newGroundWeight[0],f.randomByWeight(e)},A.prototype.generateInitScore=function(e){var t=this,n=t.year,r;n<g.config.newCityYear[0]?r=g.config.newCityWeight[0]:n<g.config.newCityYear[1]?r=g.config.newCityWeight[1]:r=g.config.newCityWeight[2];if(e){var i,s=Math.max(e.length,r.length),o=Array(s);for(i=0;i<s;i++)o[i]=(r[i]||0)+(e[i]||0);r=o,g.game.log.trace("白色地块带来权重追加，权重为：{0}",r)}var u=f.randomByWeight(r);return g.config.city[1+u].score},A.prototype.locateKey=function(e,t){return t<<4|e},A.prototype.locateXByKey=function(e){return e&15},A.prototype.locateYByKey=function(e){return e>>4},A.prototype.isHopeless=function(){var e,t,n;for(e=0;e<g.config.boardSize;e++)for(t=0;t<g.config.boardSize;t++){n=this.getBlockInfo(e,t,"type");if(n>g.config.blockTypeWhenMaxScore)continue;if(n===this.getBlockInfo(e+1,t,"type")||n===this.getBlockInfo(e,t+1,"type"))return!1}return!0},A.prototype.isDead=function(){return this.isHopeless()?this.token>0?!1:!0:!1},A.prototype.maxConnectionDetect=function(e,t){var n=this,r=n.locateKey(e,t),i=n.getBlockInfoByKey(r,"type");if(i===g.config.blockTypeFinal)return[];var s=[r],o=0,u=s.length,a={};a[r]=!0;var f,l;while(o<u){r=s[o],o++;for(f=0;f<4;f++){l=r+A.MOVEMENTS[f];if(a[l])continue;a[l]=!0,n.getBlockInfoByKey(l,"type")===i&&(s.push(l),u++)}}return s},A.prototype.tryMerge=function(e,t){var n=this,r=n.maxConnectionDetect(e,t),i=r.length;if(i<=1)return!1;var s,o,u=0,a=0,f,l,c,h,p,d=n.getBlockInfoByKey(r[0],"type");if(d===g.config.blockTypeWhenMaxScore){l=g.config.maxCityLevelByScore,c=l+i-1,n.setBlockInfoByKey(r[0],"level",c),n.setBlockInfoByKey(r[0],"type",g.config.blockTypeFinal);var v=g.config.city[c].token;v>0&&n.setToken(this.token+v),h=Array(g.config.maxCityLevel);for(s=1;s<=g.config.maxCityLevel;s++)p=g.config.city[s].whiteRequest,p&&i>p?h[s]=g.config.city[s].weight:h[s]=0}else{for(s=0;s<i;s++)f=n.getBlockInfoByKey(r[s],"score"),a+=f,u=Math.max(u,f);n.setBlockInfoByKey(r[0],"score",a),l=n.calcCityLevelByScore(u),c=n.calcCityLevelByScore(a),c>=g.config.maxCityLevelByScore&&n.setBlockInfoByKey(r[0],"type",g.config.blockTypeWhenMaxScore)}var m,y,b,w={},E={},S;for(e=0;e<g.config.boardSize;e++){m=g.config.boardSize,S=[];for(t=g.config.boardSize-1;t>=0;t--){b=!1;do{m--;if(m<0)break;y=n.locateKey(e,m);if(r.indexOf(y)<=0){b=!0;break}S.push(y)}while(!0);b?(o=n.getBlockInfoByKey(y),n.setBlockInfo(e,t,null,o),w[y]=n.locateKey(e,t)):(n.initBlock(e,t,h),E[S.pop()]={from:m,to:n.locateKey(e,t)})}}var x=n.population;return n.newYearComing(n.year+1),g.e.dispatch("newCity",c),{connection:r,movement:w,newBlock:E,lastPopulation:x,lastMaxCityLevel:l,cityLevel:c,baseType:d}},A.prototype.newYearComing=function(e){var t=this;t.setYear(e),t.calcPopulation(),t.hopeless=t.isHopeless(),t.dead=t.hopeless&&this.token<=0,t.saveToStorage()},A.prototype.destoryBlock=function(e,t){var n=this;if(n.token<=0){g.game.log.trace("没有有效的工人来拆除。");return}var r=n.token-1;n.setToken(r);var i={},s={},o,u,a;for(o=t-1;o>=0;o--)n.setBlockInfo(e,o+1,null,n.getBlockInfo(e,o)),i[n.locateKey(e,o)]=n.locateKey(e,o+1);for(o=0;o<g.config.boardSize;o++){u=o===e?t+1:0;for(;u<g.config.boardSize;u++)a=n.locateKey(o,u),i[a]=a}n.initBlock(e,0),s[n.locateKey(e,t)]={from:-1,to:n.locateKey(e,0)};var f=n.population;return n.newYearComing(n.year+1),{movement:i,newBlock:s,lastPopulation:f,token:r,x:e,y:t,destroy:!0}},A.prototype.calcCityLevelByScore=function(e){var t=g.config.score2Level;return e>=t.length?t[t.length-1]:t[e]},A.prototype.getDirectionByMovement=function(e,t){return e*=1,t*=1,e===1&&t===0?A.DIR_RIGHT:e===-1&&t===0?A.DIR_LEFT:e===0&&t===-1?A.DIR_DOWN:A.DIR_UP},A.prototype.movementX=function(e){return e===A.DIR_RIGHT?1:e===A.DIR_LEFT?-1:0},A.prototype.movementY=function(e){return e===A.DIR_UP?-1:e===A.DIR_DOWN?1:0};var O=qc.defineBehaviour("qc.engine.LoadFullRes",qc.Behaviour,function(){},{cityImage:qc.Serializer.STRING});O.prototype.awake=function(){var e=this,n=e.cityImage.replace("_full","");g.game.assets.load(n,e.cityImage,function(e){var r=g.game,i=r.assets._cache,s=e.img;i._images[n].data=s,PIXI.BaseTextureCache[n].source=s,e.url=n,r.assets.cache(n,n,e),r.dirtyRectangle.forceDirty=!0;var o=qc.CanvasPool,u=o.pool,a=o.unused,f=t.keys(u);for(var l=0,c=f.length;l<c;l++){var h=f[l],p=u[h];p.width=1,p.height=1,a.push(p)}o.pool={}},!0)};var M=qc.defineBehaviour("qc.engine.MainMenu",qc.Behaviour,function(){},{closeBtn:qc.Serializer.NODE,restartBtn:qc.Serializer.NODE,buildingBtn:qc.Serializer.NODE,guideBtn:qc.Serializer.NODE,shareBtn:qc.Serializer.NODE,selectionMenuHandler:qc.Serializer.NODE,buildingMenu:qc.Serializer.NODE});M.prototype.awake=function(){var e=this;g.uiEvent.add(function(t){switch(t){case"mainMenuClick":case"followMsgClose":case"rankingClose":if(arguments[1]&&arguments[1]!==e.class)return;e.show()}}),e.addListener(e.closeBtn.onClick,e.close,e),e.addListener(e.restartBtn.onClick,e.restart,e),e.addListener(e.buildingBtn.onClick,e.showBuilding,e),e.addListener(e.guideBtn.onClick,e.showGuild,e),e.addListener(e.shareBtn.onClick,e.doShare,e),e.gameObject.visible=!1},M.prototype.show=function(){var e=this;g.status.setBusy(!0),e.gameObject.parent.visible=!0,e.gameObject.visible=!0,e.canClick=!1;var t=e.getScript("qc.TweenPosition");t.resetToBeginning(),t.playForward(),g.game.timer.add(t.duration*1e3,function(){e.canClick=!0})},M.prototype.shutdown=function(){var e=this;e.gameObject.visible=!1,e.gameObject.parent.visible=!1,g.status.setBusy(!1)},M.prototype.close=function(){this._doClose()},M.prototype._doClose=function(e){var t=this;t.canClick=!1;var n=t.getScript("qc.TweenPosition");n.resetToBeginning(!0),n.playReverse(),g.game.timer.add(n.duration*1e3,function(){t.shutdown(),e&&e()})},M.prototype.restart=function(){var e=this;e._doClose(function(){e.selectionMenuHandler.getScript("SubaraCity.SelectionMenu").show(null,"确定要重新开始游戏吗？",function(e){if(e!==!0)return;g.game.timer.add(1,function(){g.city.newCity()})});return})},M.prototype.showBuilding=function(){var e=this;if(!e.canClick)return;e._doClose(function(){e.buildingMenu.getScript("qc.engine.BuildingMenu").show()})},M.prototype.showGuild=function(){var e=this;if(!e.canClick)return;e._doClose(function(){g.uiEvent.dispatch("guideMenuShow")})},M.prototype.doShare=function(){if(!this.canClick)return;g.uiEvent.dispatch("showShareMask",this.class)},M.prototype.hide=function(){this.close()};var _=qc.defineBehaviour("SubaraCity.Ranking",com.qici.extraUI.TableViewAdapter,function(){this._dispatchClass=""},{rankingList:qc.Serializer.NODE,ownRanking:qc.Serializer.NODE,closeBtn:qc.Serializer.NODE,waiting:qc.Serializer.NODE});_.prototype.awake=function(){this.addListener(this.closeBtn.onClick,this.close,this),this.addListener(g.uiEvent,function(e){switch(e){case"showRanking":this.getRanking(),this.show(arguments[1])}},this)},_.prototype.getRanking=function(){var e=this,t=g.me;qc.Interactive.getRank(t.rid,t.token,t.channel,this.onGetRankSuccess.bind(this))},_.prototype.onGetRankSuccess=function(e){e=JSON.parse(e);var t=g.me,n=0,r=e.rankTop;for(var i=0;i<r.length;i++){var s=r[i];s.rid===t.rid&&(n=i+1),s.ranking=i+1}e.selfRank=e.userData[0],e.selfRank&&(e.selfRank.ranking=n),this.initOwnRanking(e.selfRank),this.rankTop=r,this.waiting.visible=!1,this.waiting.stop(),this.dispatchDataChange()},_.prototype.getTableSize=function(){return{x:1,y:this.rankTop?this.rankTop.length:0}},_.prototype.findCellWithPos=function(e,t){return{x:Math.floor(e/596),y:Math.floor(t/140)}},_.prototype.getCellRect=function(e,t){var n=this.rankingList.getScript("com.qici.extraUI.TableView");return new qc.Rectangle(e*596,t*140+n.extraTop,596,125)},_.prototype.revokeCell=function(e,t,n){e.getScript("SubaraCity.RankingItem").revoke()},_.prototype.createCell=function(e,t,n){this.rankTop&&e.getScript("SubaraCity.RankingItem").initItem(this.rankTop[n]),g.uiEvent.dispatch("createRankCell",this.gameObject)},_.prototype.initOwnRanking=function(e){if(e){this.ownRanking.visible=!0;var t=this.ownRanking.getScript("SubaraCity.RankingItem");t.initItem(e)}},_.prototype.close=function(){var e=this;if(!e.canClick)return;e.canClick=!1,g.status.setBusy(!0);var t=e.getScript("qc.TweenPosition");t.onFinished.addOnce(e.shutdown,e),t.resetToBeginning(!0),t.playReverse()},_.prototype.show=function(e){this._dispatchClass=e,this.gameObject.visible=!0,this.waiting.visible=!0,this.waiting.playAnimation("zhuan",null,!0);var t=this;g.status.setBusy(!0),t.gameObject.parent.visible=!0,t.gameObject.visible=!0,t.canClick=!1;var n=t.getScript("qc.TweenPosition");n.resetToBeginning(),n.playForward(),g.game.timer.add(n.duration*1e3,function(){t.canClick=!0})},_.prototype.shutdown=function(){var e=this;e.gameObject.visible=!1,e.gameObject.parent.visible=!1,e.ownRanking.visible=!1,g.me.rid&&this.game.assets.unload(g.me.rid),g.uiEvent.dispatch("rankingClose",e._dispatchClass),g.status.setBusy(!1)};var D=qc.defineBehaviour("SubaraCity.RankingItem",qc.Behaviour,function(){this._headKey=""},{headIcon:qc.Serializer.NODE,rankingIcon:qc.Serializer.NODE,rankingLabel:qc.Serializer.NODE,userName:qc.Serializer.NODE,scoreLabel:qc.Serializer.NODE});D.updateTexture=function(e){this.texture=e},D._rankingIconMap={1:"one.png",2:"two.png",3:"three.png"},D._rankingBoxs=["rank1.png","rank6.png","yajun.png","jijun.png"],D._rankingLabelColors=[{color:new qc.Color("#bbb39e"),stroke:new qc.Color("#0a6752")},{color:new qc.Color("#ffdb49"),stroke:new qc.Color("#915308")},{color:new qc.Color("#b9e2e6"),stroke:new qc.Color("#08716d")},{color:new qc.Color("#d7a367"),stroke:new qc.Color("#6f4610")}],D._rankingLabelSizes=[29,50,34],D.prototype.initItem=function(e){this.userName.text=e.name,this.scoreLabel.text=f.toText(e.scorers)+"";if(e.headurl){var t=e.headurl+"132";this._headKey=e.rid,this.game.assets.loadTexture(this._headKey,t,D.updateTexture.bind(this.headIcon))}else this.headIcon.texture=this.game.assets.find("Assets/atlas/city.bin"),this.headIcon.frame="zhezhao.png";var n=!1,r=e.ranking+"",i=D._rankingLabelSizes[1],s=D._rankingLabelColors[0],o=D._rankingBoxs[0];e.ranking?e.ranking<4&&(n=!0,this.rankingIcon.frame=D._rankingIconMap[e.ranking+""],r="NO."+e.ranking,i=D._rankingLabelSizes[0],s=D._rankingLabelColors[e.ranking],o=D._rankingBoxs[e.ranking]):(i=D._rankingLabelSizes[2],r="100+"),this.headIcon.parent.parent.frame=o,this.rankingLabel.text=r,this.rankingLabel.fontSize=i,this.rankingLabel.color=s.color,this.rankingLabel.stroke=s.stroke,this.rankingIcon.visible=n},D.prototype.revoke=function(){this._headKey&&(this.game.assets.unload(this._headKey),this._headKey=null)};var P=qc.defineBehaviour("SubaraCity.SelectionMenu",qc.Behaviour,function(){},{selectionNode:qc.Serializer.NODE,menuNode:qc.Serializer.NODE,boardNode:qc.Serializer.NODE,bottomNode:qc.Serializer.NODE,textNode:qc.Serializer.NODE,yesBtn:qc.Serializer.NODE,noBtn:qc.Serializer.NODE,destroyExtraImage:qc.Serializer.NODE});P.prototype.awake=function(){var e=this;e.selectionShiftX=e.selectionNode.x,e.selectionShiftY=e.selectionNode.y,e.selectionNode.visible=!1,e.menuNode.parent.visible=!1,e.addListener(e.yesBtn.onClick,function(){e.response(!0)}),e.addListener(e.noBtn.onClick,function(){e.response(!1)}),e.addListener(e.menuNode.getScript("qc.TweenPosition").onFinished,function(){e._isShow||(e.menuNode.parent.visible=!1)})},P.prototype.response=function(e){var t=this;t._isShow=!1,t.destroyExtraImage.visible=!1,t.selectionNode.visible=!1;var n=t.menuNode.getScript("qc.TweenPosition");n.playReverse(),t.boardNode.alpha=1,t.bottomNode.alpha=1,t.target&&(t.target.alpha=1),delete t.target;var r=t.boardNode.getScript("SubaraCity.Board").blockCtrollers,i,s,o,u;for(s=0,o=r.length;s<o;s++)i=r[s],i.shadowImage.visible=!0,u=i.bgImage,u.left=u.right=u.bottom=u.top=-1,u=i.highHintImage,u.left=u.right=u.bottom=u.top=-1;g.status.setBusy(!1),t.handler&&t.handler(e)},P.prototype.show=function(e,t,n){var r=this,i;r._isShow=!0,g.status.setBusy(!0),e&&(r.selectionNode.visible=!0,r.selectionNode.x=r.selectionShiftX+e.x,r.selectionNode.y=r.selectionShiftY+e.y,i=r.selectionNode.getScript("qc.TweenAlpha"),i.resetToBeginning(),i.playForward()),r.menuNode.parent.visible=!0,r.textNode.text=t,i=r.menuNode.getScript("qc.TweenPosition"),i.resetToBeginning(),i.playForward(),r.boardNode.alpha=.3,r.bottomNode.alpha=.8,e&&(e.alpha=1/.3);var s=r.boardNode.getScript("SubaraCity.Board").blockCtrollers,o,u,a,f;for(u=0,a=s.length;u<a;u++)o=s[u],o.shadowImage.visible=!1,f=o.bgImage,f.left=f.right=f.bottom=f.top=0,f=o.highHintImage,f.left=f.right=f.bottom=f.top=0;t===g.config.destroyHint&&(r.destroyExtraImage.visible=!0),e&&(r.target=e),r.handler=n};var H=qc.defineBehaviour("SubaraCity.ShareMask",qc.Behaviour,function(){this._dispatchClass=""},{label:qc.Serializer.NODE,arrow:qc.Serializer.NODE});H.prototype.awake=function(){this.addListener(g.uiEvent,function(e){if(e!=="showShareMask")return;this.show(arguments[1])},this),this.addListener(this.gameObject.onClick,this.hide,this)},H.prototype.show=function(e){this._dispatchClass=e,this.arrow.visible=qc.qcWeChat.isWeChat(),this.arrow.visible?this.label.text="点击右上角\n分享给您的好友们吧\n看看他们能取得多少分":this.label.text="请使用分享功能\n告诉您的好友们吧\n看看他们能取得多少分",this.gameObject.visible=!0},H.prototype.hide=function(){this.gameObject.visible=!1,g.uiEvent.dispatch("shareMaskClose",this.gameObject)};var B=qc.defineBehaviour("qc.engine.Star",qc.Behaviour,function(){},{});B.prototype.awake=function(){var e=this;e.children=this.gameObject.children,e.children.forEach(function(e){e.onFinished.add(function(){e.visible=!1})}),g.uiEvent.add(function(t,n,r,i){if(t!=="cityUpgrade")return;e.playStartEffect(n,r)})},B.prototype.playStartEffect=function(e,t){var n,r,i,s=this.children;for(n=0,r=s.length;n<r;n++){i=s[n];if(!i.visible){i.visible=!0,i.x=e,i.y=t,i.playAnimation("start",.6);break}}};var j=qc.defineBehaviour("qc.TweenText",qc.Tween,function(){var e=this;e.from=0,e.to=1,e.enable=!1},{from:qc.Serializer.NUMBER,to:qc.Serializer.NUMBER});j.__menu="Tween/TweenText",j.prototype.onUpdate=function(e,t){var n=this,r=n.from,i=n.to;n.gameObject.text=f.toText(Math.round(r+e*(i-r)))},j.prototype.setStartToCurrValue=function(){this.gameObject.text=f.toText(this.from)},j.prototype.setEndToCurrValue=function(){this.gameObject.text=f.toText(this.to)},j.prototype.setCurrToStartValue=function(){this.from=this.fromText(this.gameObject.text)},j.prototype.setCurrToEndValue=function(){this.to=this.gameObject.text.replace(",","")*1},j.prototype.fromText=function(e){return Math.round(x.replace(/,/g,""))},j.begin=function(e,t,n){var r=qc.Tween.begin("qc.TweenText",e,t);return r.from=this.gameObject.text*1,r.to=n,t<=0&&(r.sample(1,!0),r.enable=!1),r};var F=qc.defineBehaviour("SubaraCity.UIControl",qc.Behaviour,function(){},{restartBtn:qc.Serializer.NODE,board:qc.Serializer.NODE,yearLabel:qc.Serializer.NODE,subaraConfig:qc.Serializer.EXCELASSET,workerNum:qc.Serializer.NODE,workerBtn:qc.Serializer.NODE});F.prototype.awake=function(){var e=this;g.config.parseConfig(e.subaraConfig),e.addListener(e.restartBtn.onClick,function(){e.onRestart()}),e.addListener(e.workerBtn.onClick,function(){e.onShowWorkerGuide()}),e.addListener(e.board.onClick,function(t,n){e.onBoardClick(n.source.x,n.source.y)}),g.uiEvent.add(function(t){t==="animationStart"?e.isAnimating=!0:t==="animationEnd"?(e.isAnimating=!1,e.tryNewbieGuide()):t==="login"&&(g.e.dispatch("restoreData"),g.e.dispatch("restoreFromStorage"),e.show())}),g.uiEvent.dispatch("login")},F.prototype.update=function(){var e=this;e.yearLabel.text=""+(g.city.year||0)},F.prototype.onRestart=function(){if(g.status.isBusy()){g.game.log.trace("Im busy now, do not click me");return}g.uiEvent.dispatch("mainMenuClick")},F.prototype.tryNewbieGuide=function(){if(!g.achievement.isNewbie())return;g.achievement.markNewbieGuided(),g.status.setBusy(!0),g.game.timer.add(g.config.newbieGuideTimeout,function(){g.uiEvent.dispatch("guideMenuShow")})},F.prototype.onShowWorkerGuide=function(){if(g.status.isBusy()){g.game.log.trace("Im busy now, do not click me");return}g.uiEvent.dispatch("guideMenuShow",[1])},F.prototype.onBoardClick=function(e,t,n){if(g.status.isBusy()){g.game.log.trace("Im busy now, do not click me");return}var r=this,i=r.board.toLocal(new qc.Point(e,t));e=Math.floor(i.x/g.config.blockSize),t=Math.floor(i.y/g.config.blockSize),g.game.log.trace("点 ({0},{1}) 被点击",e,t);if(!g.status.isGaming()){g.game.log.trace("非游戏中不响应");return}var s=g.city.locateKey(e,t);if(g.city.getBlockInfoByKey(s,"type")===g.config.needRemindWhenMerge&&!n){var o=!1;for(var u=0;u<4;u++)if(g.city.getBlockInfoByKey(s+A.MOVEMENTS[u],"type")===g.config.needRemindWhenMerge){o=!0;break}if(o){var a=this.board.getScript("SubaraCity.Board").getControllerByKey(g.city.locateKey(e,t));this.getScript("SubaraCity.SelectionMenu").show(a.gameObject,g.config.highCityMergeHint,function(n){if(n!==!0)return;r.dealPosClick(e,t)});return}}r.dealPosClick(e,t)},F.prototype.dealPosClick=function(e,t){var n=g.city.tryMerge(e,t),r=this;if(!n){if(g.city.token<=0){g.game.log.trace("没有有效的工人来进行拆除。");return}g.game.log.trace("点 ({0},{1}) 不允许合并，提示是否要摧毁。",e,t);var i=this.board.getScript("SubaraCity.Board").getControllerByKey(g.city.locateKey(e,t));this.getScript("SubaraCity.SelectionMenu").show(i.gameObject,g.config.destroyHint,function(n){if(n!==!0)return;g.game.log.trace("地块{0}/{1}拆除了，处理动画！！！",e,t);var i=g.city.destoryBlock(e,t);i&&(r.workerNum.text=""+i.token,r.board.getScript("SubaraCity.Board").playAnimation(i))});return}g.game.log.trace("{0}个点成功合并，处理动画。",n.connection.length),this.board.getScript("SubaraCity.Board").playAnimation(n)},F.prototype.show=function(){this.gameObject.visible=!0,this.workerBtn.visible=!0};var I=qc.defineBehaviour("SubaraCity.Welcome",qc.Behaviour,function(){this.addListener(g.e,function(e){e==="configLoaded"&&this._btnEnable()},this)},{quickBtn:qc.Serializer.NODE,wechartBtn:qc.Serializer.NODE,mask:qc.Serializer.NODE});I.prototype.awake=function(){this.addListener(this.quickBtn.onClick,this._quickLogin,this),this.addListener(this.wechartBtn.onClick,this._wechartLogin,this),this.addListener(g.uiEvent,function(e){if(e!=="login")return;this.hide()},this);var e=this.getScript("qc.QcWeChat");this.quickBtn.visible=!e.isWeChat(),this.quickBtn.parent.getScript("qc.TableLayout").rebuildTable(),this.addListener(e.onStartLogin,function(){this.mask.visible=!0},this),this.addListener(e.onLogin,function(e){e==="success"&&this._loginSuccess(),this.mask.visible=!1},this),this.addListener(qc.qcWeChat.onShare,function(e){e.title=g.config.share.getContent(g.city.population),e.imgUrl=g.config.shareIcon,e.desc=""},this)},I.prototype._loginSuccess=function(){var e=this.getScript("qc.QcWeChat");if(!e.user)return;var t=g.me;t.token=e.user.token,t.rid=e.user.rid,t.subscribe=e.user.subscribe,t.userInfo=e.user,t.channel="weixin",g.uiEvent.dispatch("login");var n=t.queryUser("best")||0;n<e.user.scorers&&t.setUser("best",e.user.scorers)},I.prototype._quickLogin=function(){g.uiEvent.dispatch("login")},I.prototype._wechartLogin=function(){var e=this.getScript("qc.QcWeChat");e.login()},I.prototype._btnEnable=function(){this.quickBtn.interactive=!0,this.wechartBtn.interactive=!0},I.prototype.show=function(){this.gameObject.visible=!0},I.prototype.hide=function(){this.gameObject.visible=!1};var q=qc.defineBehaviour("qc.engine.WorkerAdd",qc.Behaviour,function(){},{rollIcon:qc.Serializer.NODE});q.prototype.awake=function(){var e=this;g.uiEvent.add(function(t){t==="restart"?e.gameObject.text=""+g.city.token:t==="animationEnd"&&e.gameObject.text!=""+g.city.token&&e.addByYear()})},q.prototype.addByYear=function(){var e=this;e.rollIcon.parent.visible=!0;var t=e.rollIcon.getScript("qc.TweenRotation");t.resetGroupToBeginning(),t.playGroup(),g.game.timer.add(g.config.tweenWorkerAddTextDelay,function(){var t=e.gameObject.getScript("qc.TweenText");t.from=g.city.token-1,t.to=g.city.token,t.resetGroupToBeginning(),t.playGroup()}),g.game.timer.add(1e3*t.duration,function(){e.rollIcon.parent.visible=!1})},q.prototype.addByCityLevel=function(e){var t=this,n=t.gameObject.getScript("qc.TweenText");n.from=parseInt(t.gameObject.text),n.to=n.from+e,n.resetGroupToBeginning(),n.playGroup()};var R=qc.defineBehaviour("qc.engine.WorkerTwinkle",qc.Behaviour,function(){},{});R.prototype.awake=function(){var e=this;e.tweenCtrl=e.gameObject.getScript("qc.TweenAlpha"),g.uiEvent.add(function(t){if(t==="animationEnd"){if(!g.city.hopeless||g.city.dead)return;e.redraw()}else t==="animationStart"&&(e.gameObject.visible=!1)}),e.gameObject.visible=!1},R.prototype.redraw=function(){var e=this;e.gameObject.visible=!0,e.tweenCtrl.resetGroupToBeginning(),e.tweenCtrl.playGroupForward()};var U=function(){var e=this;g.e.add(function(t,n){t==="newCity"?e.onNewCity(n):t==="restoreFromStorage"&&e.tryRestoreFromStorage();return})};U.prototype.constructor=U,U.prototype.onNewCity=function(e){if(!this.buildAchievement)return;if(this.buildAchievement[e])return;this.buildAchievement[e]=!0,g.me.setUser("achievement",this.buildAchievement)},U.prototype.tryRestoreFromStorage=function(){var e=g.me.queryUser("achievement");e?this.buildAchievement=e:this.buildAchievement={};var t=g.me.queryUser("isNewbie");this.newbie=t!==!1},U.prototype.isLevelReach=function(e){if(e<3)return!0;var t=this.buildAchievement||{};return t[e]===!0},U.prototype.isNewbie=function(){return this.newbie===!0},U.prototype.markNewbieGuided=function(){this.newbie=!1,g.me.setUser("isNewbie",!1)},Phaser.SoundManager.prototype.boot=function(){this.game.device.iOS&&this.game.device.webAudio===!1&&(this.channels=1);if(e.PhaserGlobal){if(e.PhaserGlobal.disableAudio===!0){this.usingWebAudio=!1,this.noAudio=!0;return}if(e.PhaserGlobal.disableWebAudio===!0){this.usingWebAudio=!1,this.usingAudioTag=!0,this.noAudio=!1;return}}if(e.PhaserGlobal&&e.PhaserGlobal.audioContext)this.context=e.PhaserGlobal.audioContext;else if(!e.AudioContext){if(!!e.webkitAudioContext)try{this.context=new e.webkitAudioContext}catch(t){this.context=null,this.usingWebAudio=!1,this.noAudio=!0,console.error("SoundManager boot error!",t),qc.Util.popupError(t.message)}}else try{this.context=new e.AudioContext}catch(t){this.context=null,this.usingWebAudio=!1,this.noAudio=!0,console.error("SoundManager boot error!",t),qc.Util.popupError(t.message)}!!e.Audio&&this.context===null&&(this.usingWebAudio=!1,this.usingAudioTag=!0,this.noAudio=!1)},Phaser.SoundManager.prototype.unlock=function(){if(this.touchLocked===!1)return;if(this.game.device.webAudio===!1||e.PhaserGlobal&&e.PhaserGlobal.disableWebAudio===!0)this.touchLocked=!1,this._unlockSource=null,this.game.input._qc.touch.callbackContext=null,this.game.device.iOSVersion>8?this.game.input._qc.touch.touchEndCallback=null:this.game.input._qc.touch.touchStartCallback=null,this.game.input._qc.mouse.callbackContext=null,this.game.input._qc.mouse.mouseDownCallback=null};var z=function(){};z.prototype.constructor=z,z.prototype.parseConfig=function(e){var t=this,n,r,i,s,o,u,a,l,c=0,h=0,p;l=e.sheets.misc,a=l.rows,r=a.length;for(n=0;n<r;n++){i=a[n].key,s=a[n].value;switch(i){case"boardSize":t.boardSize=parseInt(s);break;case"blockSize":t.blockSize=parseInt(s);break;case"initToken":t.initToken=parseInt(s);break;case"initYear":t.initYear=parseInt(s);break;case"yearsAddToken":t.yearsAddToken=parseInt(s);break;case"newGroundYear":t.newGroundYear=parseInt(s);break;case"newGroundWeight":var v=f.map(s.split("|"),function(e){return parseInt(e)});t.newGroundWeight=[v.slice(0,3),v];break;case"newCityYear":t.newCityYear=f.map(s.split("|"),function(e){return parseInt(e)});break;case"adjustTimeout":t.adjustTimeout=parseInt(s);break;case"blockFadeoutTime":t.blockFadeoutTime=parseInt(s);break;case"dropDownTime":t.dropDownTime=parseInt(s);break;case"level1SubType":t.level1SubType=parseInt(s);break;case"cityFinalScalePending":t.cityFinalScalePending=parseInt(s);break;case"blockTypeWhenMaxScore":t.blockTypeWhenMaxScore=parseInt(s);break;case"blockTypeFinal":t.blockTypeFinal=parseInt(s);break;case"dieGuide":t.dieGuide=s;break;case"destroyHint":t.destroyHint=s;break;case"needRemindWhenMerge":t.needRemindWhenMerge=parseInt(s);break;case"highCityMergeHint":t.highCityMergeHint=s;break;case"tweenWorkerAddTextDelay":t.tweenWorkerAddTextDelay=parseInt(s);break;case"medalEffectPending":t.medalEffectPending=parseInt(s);break;case"timeoutAddWorkerWhenMedal":t.timeoutAddWorkerWhenMedal=parseInt(s);break;case"fireworkPendingTimeout":t.fireworkPendingTimeout=parseInt(s);break;case"initDropDownNumber":t.initDropDownNumber=parseInt(s);break;case"initDropDownPending":t.initDropDownPending=parseInt(s);break;case"newbieGuideTimeout":t.newbieGuideTimeout=parseInt(s);break;default:t[i]=s}}qc.qcWeChat.shareDir=t.shareDir,t.city={},l=e.sheets.city,a=l.rows,r=a.length;for(n=0;n<r;n++)p=parseInt(a[n].level),t.city[p]=a[n],p>c&&(c=p),p>h&&a[n].score&&(h=p),p===1&&(a[n].shiftX=f.map(a[n].shiftX.split("|"),function(e){return parseInt(e)}),a[n].shiftY=f.map(a[n].shiftY.split("|"),function(e){return parseInt(e)}));t.maxCityLevel=c,t.maxCityLevelByScore=h;var m=[];t.score2Level=[0];for(n=1;n<=c;n++){u=t.city[n].score,nextLevelScore=n===c?u:t.city[n+1].score,t.city[n].weight&&!t.city[n].whiteRequest&&m.push(t.city[n].weight);if(u>0){o=u;do t.score2Level.push(n),o++;while(o<nextLevelScore)}}t.newCityWeight=[m.slice(0,m.length-2),m.slice(0,m.length-1),m],l=e.sheets.guide,t.guide=l.rows,t.share=new d(e),g.e.dispatch("configLoaded")},function(e){var t=function(e,t){return e<<t|e>>>32-t},n=function(e,t){var n,r,i,s,o;return i=e&2147483648,s=t&2147483648,n=e&1073741824,r=t&1073741824,o=(e&1073741823)+(t&1073741823),n&r?o^2147483648^i^s:n|r?o&1073741824?o^3221225472^i^s:o^1073741824^i^s:o^i^s},r=function(e,t,n){return e&t|~e&n},i=function(e,t,n){return e&n|t&~n},s=function(e,t,n){return e^t^n},o=function(e,t,n){return t^(e|~n)},u=function(e,i,s,o,u,a,f){return e=n(e,n(n(r(i,s,o),u),f)),n(t(e,a),i)},a=function(e,r,s,o,u,a,f){return e=n(e,n(n(i(r,s,o),u),f)),n(t(e,a),r)},f=function(e,r,i,o,u,a,f){return e=n(e,n(n(s(r,i,o),u),f)),n(t(e,a),r)},l=function(e,r,i,s,u,a,f){return e=n(e,n(n(o(r,i,s),u),f)),n(t(e,a),r)},c=function(e){var t,n=e.length,r=n+8,i=(r-r%64)/64,s=(i+1)*16,o=Array(s-1),u=0,a=0;while(a<n)t=(a-a%4)/4,u=a%4*8,o[t]=o[t]|e.charCodeAt(a)<<u,a++;return t=(a-a%4)/4,u=a%4*8,o[t]=o[t]|128<<u,o[s-2]=n<<3,o[s-1]=n>>>29,o},h=function(e){var t="",n="",r,i;for(i=0;i<=3;i++)r=e>>>i*8&255,n="0"+r.toString(16),t+=n.substr(n.length-2,2);return t},p=function(e){e=e.replace(/\x0d\x0a/g,"\n");var t="";for(var n=0;n<e.length;n++){var r=e.charCodeAt(n);r<128?t+=String.fromCharCode(r):r>127&&r<2048?(t+=String.fromCharCode(r>>6|192),t+=String.fromCharCode(r&63|128)):(t+=String.fromCharCode(r>>12|224),t+=String.fromCharCode(r>>6&63|128),t+=String.fromCharCode(r&63|128))}return t};e.md5=function(e){var t=Array(),r,i,s,o,d,v,m,g,y,b=7,w=12,E=17,S=22,x=5,T=9,N=14,C=20,k=4,L=11,A=16,O=23,M=6,_=10,D=15,P=21;e=p(e),t=c(e),v=1732584193,m=4023233417,g=2562383102,y=271733878;for(r=0;r<t.length;r+=16)i=v,s=m,o=g,d=y,v=u(v,m,g,y,t[r+0],b,3614090360),y=u(y,v,m,g,t[r+1],w,3905402710),g=u(g,y,v,m,t[r+2],E,606105819),m=u(m,g,y,v,t[r+3],S,3250441966),v=u(v,m,g,y,t[r+4],b,4118548399),y=u(y,v,m,g,t[r+5],w,1200080426),g=u(g,y,v,m,t[r+6],E,2821735955),m=u(m,g,y,v,t[r+7],S,4249261313),v=u(v,m,g,y,t[r+8],b,1770035416),y=u(y,v,m,g,t[r+9],w,2336552879),g=u(g,y,v,m,t[r+10],E,4294925233),m=u(m,g,y,v,t[r+11],S,2304563134),v=u(v,m,g,y,t[r+12],b,1804603682),y=u(y,v,m,g,t[r+13],w,4254626195),g=u(g,y,v,m,t[r+14],E,2792965006),m=u(m,g,y,v,t[r+15],S,1236535329),v=a(v,m,g,y,t[r+1],x,4129170786),y=a(y,v,m,g,t[r+6],T,3225465664),g=a(g,y,v,m,t[r+11],N,643717713),m=a(m,g,y,v,t[r+0],C,3921069994),v=a(v,m,g,y,t[r+5],x,3593408605),y=a(y,v,m,g,t[r+10],T,38016083),g=a(g,y,v,m,t[r+15],N,3634488961),m=a(m,g,y,v,t[r+4],C,3889429448),v=a(v,m,g,y,t[r+9],x,568446438),y=a(y,v,m,g,t[r+14],T,3275163606),g=a(g,y,v,m,t[r+3],N,4107603335),m=a(m,g,y,v,t[r+8],C,1163531501),v=a(v,m,g,y,t[r+13],x,2850285829),y=a(y,v,m,g,t[r+2],T,4243563512),g=a(g,y,v,m,t[r+7],N,1735328473),m=a(m,g,y,v,t[r+12],C,2368359562),v=f(v,m,g,y,t[r+5],k,4294588738),y=f(y,v,m,g,t[r+8],L,2272392833),g=f(g,y,v,m,t[r+11],A,1839030562),m=f(m,g,y,v,t[r+14],O,4259657740),v=f(v,m,g,y,t[r+1],k,2763975236),y=f(y,v,m,g,t[r+4],L,1272893353),g=f(g,y,v,m,t[r+7],A,4139469664),m=f(m,g,y,v,t[r+10],O,3200236656),v=f(v,m,g,y,t[r+13],k,681279174),y=f(y,v,m,g,t[r+0],L,3936430074),g=f(g,y,v,m,t[r+3],A,3572445317),m=f(m,g,y,v,t[r+6],O,76029189),v=f(v,m,g,y,t[r+9],k,3654602809),y=f(y,v,m,g,t[r+12],L,3873151461),g=f(g,y,v,m,t[r+15],A,530742520),m=f(m,g,y,v,t[r+2],O,3299628645),v=l(v,m,g,y,t[r+0],M,4096336452),y=l(y,v,m,g,t[r+7],_,1126891415),g=l(g,y,v,m,t[r+14],D,2878612391),m=l(m,g,y,v,t[r+5],P,4237533241),v=l(v,m,g,y,t[r+12],M,1700485571),y=l(y,v,m,g,t[r+3],_,2399980690),g=l(g,y,v,m,t[r+10],D,4293915773),m=l(m,g,y,v,t[r+1],P,2240044497),v=l(v,m,g,y,t[r+8],M,1873313359),y=l(y,v,m,g,t[r+15],_,4264355552),g=l(g,y,v,m,t[r+6],D,2734768916),m=l(m,g,y,v,t[r+13],P,1309151649),v=l(v,m,g,y,t[r+4],M,4149444226),y=l(y,v,m,g,t[r+11],_,3174756917),g=l(g,y,v,m,t[r+2],D,718787259),m=l(m,g,y,v,t[r+9],P,3951481745),v=n(v,i),m=n(m,s),g=n(g,o),y=n(y,d);var H=h(v)+h(m)+h(g)+h(y);return H.toLowerCase()}}(e);var W=qc.defineBehaviour("qc.QcWeChat",qc.Behaviour,function(){var t=this;qc.qcWeChat=this,t.shareAppId="",t.gameName="",t.wxAppId="",t.webAppId="",t.domain="",t.gameDomain="",t.extendParams="",t.redirectCurrentUrl=!0,t.debug=!1,t.wx=new qc.QCWX,e.QcWx=t.wx,t.onInitWx=new qc.Signal,t.onStartLogin=new qc.Signal,t.onLogin=new qc.Signal,t.sessionExpired=new qc.Signal,t.onShare=new qc.Signal,t.user=null,t.status="",t.shareLink="",t._shareBody=null,t.shareSignSuccess=!1,t.shareDir=""},{gameName:qc.Serializer.STRING,shareAppId:qc.Serializer.STRING,wxAppId:qc.Serializer.STRING,webAppId:qc.Serializer.STRING,domain:qc.Serializer.STRING,gameDomain:qc.Serializer.STRING,shareDir:qc.Serializer.STRING,redirectCurrentUrl:qc.Serializer.BOOLEAN,debug:qc.Serializer.BOOLEAN});W.prototype.awake=function(){var t=this;if(!t.domain)return;var n=t.domain+"index.php?cmd=sign&appid="+t.shareAppId+"&url="+encodeURIComponent(e.location.href);t.game.log.trace("开始请求微信分享的签名信息：{0}",n),qc.AssetUtil.get(n,function(e){t.game.log.trace("获取签名成功："+e),t.parseSign(e)},function(){console.error("获取签名信息失败")}),t.loadWXLib(),t._code=this.getParam("code"),t._state=this.getParam("state"),t._code&&(t.isWeChat()||this.game.device.desktop)&&(t.status="loggingIn",t.game.timer.add(1,function(){t.requestToken(t._code)}))},W.prototype.onDestroy=function(){this.timer&&this.game.timer.remove(this.timer)},W.prototype.login=function(){if(!this.game.device.desktop){this.loginInWX();return}this.loginInWeb()},W.prototype._gotoAuth=function(){var t="",n=e.location.origin+e.location.pathname;this.redirectCurrentUrl?t="https://open.weixin.qq.com/connect/oauth2/authorize?appid="+this.wxAppId+"&redirect_uri="+encodeURIComponent(n)+"&response_type=code&scope=snsapi_userinfo&state=weixin#wechat_redirect":t="https://open.weixin.qq.com/connect/oauth2/authorize?appid="+this.wxAppId+"&redirect_uri="+encodeURIComponent(this.domain+"code.php")+"&response_type=code&scope=snsapi_userinfo"+"&state="+encodeURIComponent(n)+"#wechat_redirect",e.location.href=t},W.prototype.loginInWX=function(){if(this.isWeChat()){this.requestToken(this._code);return}this._gotoAuth()},W.prototype.loginInWeb=function(){var t="",n=e.location.origin+e.location.pathname;this.redirectCurrentUrl?t="https://open.weixin.qq.com/connect/qrconnect?appid="+this.webAppId+"&redirect_uri="+encodeURIComponent(n)+"&response_type=code&scope=snsapi_login&state=pc#wechat_redirect":t="https://open.weixin.qq.com/connect/qrconnect?appid="+this.webAppId+"&redirect_uri="+encodeURIComponent(this.domain+"code.php")+"&response_type=code&scope=snsapi_login"+"&state="+encodeURIComponent(n)+"#wechat_redirect",e.location.href=t},W.prototype.parseSign=function(e){var t=this,n=JSON.parse(e);t.timeStamp=n.timestamp,t.nonceStr=n.nonceStr,t.signature=n.signature,t.shareLink=n.shareLink;if(!t.jweixin){t.game.timer.add(500,function(){t.parseSign(e)});return}t.game.log.trace("开始初始化微信接口"),t.wx.debug=t.debug,t.wx.init({timeStamp:t.timeStamp,nonceStr:t.nonceStr,signature:t.signature,appId:t.shareAppId},function(){t.game.log.trace("初始化微信接口完成。"),t.shareSignSuccess=!0,t.wx.share(t.onShare),t.onInitWx.dispatch()})},W.prototype.loadWXLib=function(){var e=this,t="http://res.wx.qq.com/open/js/jweixin-1.0.0.js",n=document.createElement("script");n.onerror=function(){console.error("加载jweixin库失败")},n.onload=function(){e.game.log.trace("微信接口下载完成"),e.jweixin=!0},n.setAttribute("src",t),n.setAttribute("type","text/javascript"),document.getElementsByTagName("head")[0].appendChild(n)},W.prototype.isWeChat=function(){var t=e.navigator.userAgent.toLowerCase();return t.match(/MicroMessenger/i)=="micromessenger"},W.prototype.getParam=function(e){var t=new RegExp("(\\?|#|&)"+e+"=([^&#]*)(&|#|$)"),n=location.href.match(t);return decodeURIComponent(n?n[2]:"")},W.prototype.requestToken=function(e){var t=this,n=t.gameDomain+"login03.php?code="+e+"&gameName="+t.gameName;this.game.device.desktop&&(n+="&web=1"),t.onStartLogin.dispatch(),qc.AssetUtil.get(n,function(e){var n=JSON.parse(e);if(n.error){if(n.errorCode&&n.errorCode==301){if(t.game.device.desktop){t.loginInWeb();return}t._gotoAuth();return}t.game.log.error("换取token失败，重新请求登录"),t.onLogin.dispatch("fail");return}t.game.log.trace("登录成功：{0}",e),t.status="loggedIn",t.user=n,t.onLogin.dispatch("success"),t.timer=t.game.timer.loop(3e5,t.refreshToken,t)},function(e){t.onLogin.dispatch("fail")})},W.prototype.refreshToken=function(){var e=this,t=e.gameDomain+"refresh.php";this.game.device.desktop&&(t+="?web=1"),qc.AssetUtil.get(t,function(t){var n=JSON.parse(t);if(n.error){e.status="expired",e.game.timer.remove(e.timer),delete e.timer,e.sessionExpired.dispatch();return}e.game.log.trace("刷新Access Token成功。")})};var X=qc.QCWX=function(){var e=this;e.title="",e.imgUrl="",e.desc="",e.url="",e.sign=null,e.ready=!1,e.debug=!1};X.prototype={},X.prototype.constructor=X,X.prototype.init=function(t,n){var r=this;r.sign=t;if(!e.wx)return;wx.config({debug:r.debug,appId:t.appId,timestamp:t.timeStamp,nonceStr:t.nonceStr,signature:t.signature,jsApiList:["onMenuShareTimeline","onMenuShareQQ","onMenuShareQZone","onMenuShareAppMessage","onMenuShareWeibo","startRecord","stopRecord","onVoiceRecordEnd","playVoice","pauseVoice","stopVoice","onVoicePlayEnd","uploadVoice","downloadVoice","chooseImage","previewImage","uploadImage","downloadImage","translateVoice","getNetworkType","openLocation","getLocation","closeWindow","scanQRCode"]}),wx.ready(function(){r.ready=!0,n&&n()})},X.prototype.share=function(e){var t=this;if(!t.ready){console.error("尚未初始化完成");return}var n={title:t.title,desc:"",trigger:function(){if(!e)return;e.dispatch(n),n.link=qc.qcWeChat.shareLink+qc.qcWeChat.shareDir}};wx.onMenuShareTimeline(n),wx.onMenuShareAppMessage(n),wx.onMenuShareQQ(n),wx.onMenuShareWeibo(n),wx.onMenuShareQZone(n)},X.prototype.chooseImage=function(e,t,n,r){var i=this;if(!i.ready){console.error("尚未初始化完成");return}t||(t=["original","compressed"]),n||(n=["album","camera"]),wx.chooseImage({count:e,sizeType:t,sourceType:n,success:function(e){r&&r(e.localIds)}})},X.prototype.previewImage=function(e,t){var n=this;if(!n.ready){console.error("尚未初始化完成");return}e=e||"",t=t||[],wx.previewImage({current:e,urls:t})},X.prototype.uploadImage=function(e,t,n){var r=this;if(!r.ready){console.error("尚未初始化完成");return}wx.uploadImage({localId:e,isShowProgressTips:t?1:0,success:function(e){n&&n(e.serverId)}})},X.prototype.downloadImage=function(e,t,n){var r=this;if(!r.ready){console.error("尚未初始化完成");return}wx.downloadImage({serverId:e,isShowProgressTips:t?1:0,success:function(e){n&&n(e.localId)}})},X.prototype.startRecord=function(){var e=this;if(!e.ready){console.error("尚未初始化完成");return}wx.startRecord()},X.prototype.stopRecord=function(e){var t=this;if(!t.ready){console.error("尚未初始化完成");return}wx.stopRecord({success:function(t){e&&e(t.localId)}})},X.prototype.onVoiceRecordEnd=function(e){var t=this;if(!t.ready){console.error("尚未初始化完成");return}wx.onVoiceRecordEnd({complete:function(t){e&&e(t.localId)}})},X.prototype.playVoice=function(e){var t=this;if(!t.ready){console.error("尚未初始化完成");return}wx.playVoice({localId:e})},X.prototype.pauseVoice=function(e){var t=this;if(!t.ready){console.error("尚未初始化完成");return}wx.pauseVoice({localId:e})},X.prototype.stopVoice=function(e){var t=this;if(!t.ready){console.error("尚未初始化完成");return}wx.stopVoice({localId:e})},X.prototype.onVoicePlayEnd=function(e){var t=this;if(!t.ready){console.error("尚未初始化完成");return}wx.onVoicePlayEnd({success:function(t){e&&e(t.localId)}})},X.prototype.uploadVoice=function(e,t,n){var r=this;if(!r.ready){console.error("尚未初始化完成");return}wx.uploadVoice({localId:e,isShowProgressTips:t?1:0,success:function(e){n&&n(e.serverId)}})},X.prototype.downloadVoice=function(e,t,n){var r=this;if(!r.ready){console.error("尚未初始化完成");return}wx.downloadVoice({serverId:e,isShowProgressTips:t?1:0,success:function(e){n&&n(e.localId)}})},X.prototype.translateVoice=function(e,t,n){var r=this;if(!r.ready){console.error("尚未初始化完成");return}wx.translateVoice({localId:e,isShowProgressTips:t?1:0,success:function(e){n&&n(e.translateResult)}})},X.prototype.getNetworkType=function(e){var t=this;if(!t.ready){console.error("尚未初始化完成");return}wx.getNetworkType({success:function(t){e&&e(t.networkType)}})},X.prototype.openLocation=function(e,t,n,r,i,s){var o=this;if(!o.ready){console.error("尚未初始化完成");return}e=e||0,t=t||0,i=i||1,n=n||"",r=r||"",s=s||"",wx.openLocation({latitude:e,longitude:t,name:n,address:r,scale:i,infoUrl:s})},X.prototype.getLocation=function(e,t){var n=this;if(!n.ready){console.error("尚未初始化完成");return}e=e||"wgs84",wx.getLocation({type:e,success:t})},X.prototype.scanQRCode=function(e,t){var n=this;if(!n.ready){console.error("尚未初始化完成");return}wx.scanQRCode({needResult:e,scanType:["qrCode","barCode"],success:function(e){t&&t(e.resultStr)}})},X.prototype.closeWindow=function(){var e=this;if(!e.ready){console.error("尚未初始化完成");return}wx.closeWindow()},X.prototype.chooseWXPay=function(){}}).call(this,this,Object)